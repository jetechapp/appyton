<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="QOTIA - Gestion & Devis BTP">
    <title>QOTIA | Gestion & Devis BTP (Pro 2025)</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- VARIABILI & RESET --- */
        :root {
            --brand-yellow: #FCD34D;
            --brand-yellow-dark: #F59E0B;
            --brand-navy: #1E3A8A;
            --brand-dark: #1F2937;
            --brand-grey-bg: #F3F4F6;
            --brand-white: #FFFFFF;
            --brand-border: #E5E7EB;
            --brand-danger: #EF4444;
            --brand-success: #10B981;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --header-height: 64px;
            --sidebar-width: 280px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; outline: none; }
        body { background-color: var(--brand-grey-bg); color: var(--brand-dark); line-height: 1.5; font-size: 13px; height: 100vh; overflow: hidden; }
        
        /* UTILITIES */
        .responsive-text { display: none; }
        @media(min-width: 600px) { .responsive-text { display: inline; } }
        .text-bold { font-weight: 700; }
        .text-navy { color: var(--brand-navy); }
        .w-full { width: 100%; }
        .mb-2 { margin-bottom: 0.5rem; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--brand-navy); z-index: 50000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-card { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        .login-logo { width: 60px; height: 60px; background: var(--brand-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 800; color: white; margin: 0 auto 20px; }
        .login-title { font-size: 1.5rem; font-weight: 800; color: var(--brand-navy); margin-bottom: 20px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--brand-border); border-radius: 8px; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background: var(--brand-navy); color: white; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .login-btn:hover { background: #1e40af; }

        /* --- LAYOUT PRINCIPALE CON HEADER FISSO --- */
        .app-container { display: flex; flex-direction: column; height: 100%; padding-top: var(--header-height); }
        .top-header { position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); background-color: var(--brand-white); border-bottom: 1px solid var(--brand-border); padding: 0 24px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }

        /* --- SEARCH BAR --- */
        .header-search-container { flex: 1; display: flex; justify-content: center; margin: 0 20px; max-width: 500px; }
        .header-search-box { position: relative; width: 100%; }
        .header-search-input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 50px; border: 1px solid var(--brand-border); background: #F3F4F6; font-size: 0.9rem; outline: none; transition: all 0.2s ease-in-out; }
        .header-search-input:focus { background: white; border-color: var(--brand-navy); box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }
        .header-search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #9CA3AF; pointer-events: none; }
        @media (max-width: 900px) { .header-search-container { display: none; } }

        /* HEADER ELEMENTS & UNIFIED NAVIGATION */
        .header-left { display: flex; align-items: center; gap: 15px; }
        .global-menu-btn { background: transparent; border: none; font-size: 1.2rem; color: var(--brand-navy); cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s; }
        .global-menu-btn:hover { background: #F3F4F6; }
        .header-brand { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logo-circle { width: 32px; height: 32px; background: var(--brand-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .header-title { font-weight: 800; color: var(--brand-navy); font-size: 18px; letter-spacing: -0.5px; }
        .header-right-actions { display: flex; gap: 10px; align-items: center; }
        .nav-link-btn { display: flex; align-items: center; gap: 8px; padding: 8px 14px; border-radius: 8px; color: #4B5563; background: transparent; border: 1px solid transparent; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .nav-link-btn:hover { background: #F3F4F6; color: var(--brand-navy); }
        .nav-link-btn.active { background: #EFF6FF; color: var(--brand-navy); }
        .nav-link-btn.btn-accent { color: var(--brand-navy); }
        .mode-switch-internal { background: #fff; padding: 3px; border-radius: 50px; display: inline-flex; border: 1px solid var(--brand-border); margin-left: 10px; }
        .mode-btn { padding: 4px 10px; border-radius: 40px; border: none; background: transparent; font-size: 10px; font-weight: 600; cursor: pointer; color: #6B7280; }
        .mode-btn.active { background: var(--brand-grey-bg); color: var(--brand-navy); }

        /* SIDEBAR */
        #global-sidebar { position: fixed; top: 0; left: -300px; width: 260px; height: 100%; background: white; z-index: 2000; border-right: 1px solid var(--brand-border); transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: 10px 0 25px rgba(0,0,0,0.05); }
        #global-sidebar.open { left: 0; }
        .gs-header { height: 64px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--brand-border); justify-content: space-between; }
        .gs-links { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .gs-link { padding: 12px 15px; border-radius: 8px; color: #4B5563; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; }
        .gs-link:hover { background: #F3F4F6; color: var(--brand-navy); }
        .gs-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1999; display: none; }
        .gs-overlay.active { display: block; }

        /* VIEWS & CONTENT */
        .view-section { display: none; height: calc(100vh - 64px); position: relative; }
        .view-section.active-section { display: grid; }
        #home-view { display: none; padding: 25px; overflow-y: auto; background: var(--brand-grey-bg); }
        #home-view.active-section { display: block; }
        .dash-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end; }
        .dash-title { font-size: 1.8rem; font-weight: 800; color: var(--brand-navy); margin-bottom: 5px; }
        .dash-subtitle { color: #6B7280; font-size: 0.9rem; }
        .kpi-filter-box { display: flex; align-items: center; gap: 10px; background: white; padding: 5px 10px; border-radius: 8px; border: 1px solid var(--brand-border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-select { border: none; font-weight: 600; color: var(--brand-navy); font-size: 0.9rem; cursor: pointer; padding: 5px; outline: none; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-card); border: 1px solid var(--brand-border); display: flex; flex-direction: column; position: relative; }
        .kpi-card.clickable { cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
        .kpi-card.clickable:hover { transform: translateY(-2px); border-color: var(--brand-navy); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .kpi-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 15px; }
        .kpi-label { font-size: 0.8rem; font-weight: 600; color: #6B7280; text-transform: uppercase; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--brand-dark); margin-top: 5px; }
        .kpi-sub { font-size: 0.8rem; color: #9CA3AF; margin-top: auto; padding-top: 10px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-card); border: 1px solid var(--brand-border); display: flex; flex-direction: column; height: 320px; }
        .chart-container { flex: 1; position: relative; width: 100%; min-height: 0; }
        .card { background: var(--brand-white); border-radius: var(--radius-md); box-shadow: var(--shadow-card); border: 1px solid var(--brand-border); overflow: hidden; margin-bottom: 20px; }
        .sidebar-title { padding: 15px; font-weight: 700; color: var(--brand-navy); border-bottom: 1px solid var(--brand-border); font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .box-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--brand-navy); background: #F9FAFB; }
        #list-view { grid-template-columns: 1fr; padding: 20px; background: var(--brand-grey-bg); overflow-y: auto; }
        
        /* EDITOR LAYOUT */
        #quote-view { grid-template-columns: var(--sidebar-width) 1fr 340px; gap: 20px; padding: 20px; overflow: hidden; }
        #client-view { grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; background: var(--brand-grey-bg); overflow: hidden; }
        #company-view { display: none; grid-template-columns: 1fr; max-width: 800px; margin: 0 auto; padding: 40px 20px; overflow-y: auto; }
        #company-view.active-section { display: block; }
        
        .col-scroll { overflow-y: auto; height: 100%; padding-right: 5px; padding-bottom: 20px; }
        .col-scroll::-webkit-scrollbar { width: 6px; }
        .col-scroll::-webkit-scrollbar-thumb { background-color: #D1D5DB; border-radius: 10px; }
        
        /* TABLES */
        .dash-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .dash-table th { text-align: left; padding: 12px 15px; background: #fff; color: #6B7280; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; border-bottom: 1px solid var(--brand-border); }
        .dash-table td { padding: 12px 15px; border-bottom: 1px solid var(--brand-border); vertical-align: middle; color: #374151; }
        .dash-table tr:hover { background: #F9FAFB; }
        .status-select-table { border: 1px solid transparent; border-radius: 15px; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; cursor: pointer; outline: none; }
        .status-select-table.st-brouillon { background: #F3F4F6; color: #374151; border-color: #E5E7EB; }
        .status-select-table.st-attente { background: #FFF7ED; color: #C2410C; border-color: #FFEDD5; }
        .status-select-table.st-accepte { background: #ECFDF5; color: #047857; border-color: #A7F3D0; }
        .status-select-table.st-refuse { background: #FEF2F2; color: #B91C1C; border-color: #FECACA; }
        .action-mini-btn { width: 30px; height: 30px; border-radius: 6px; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; background: white; border-color: #E5E7EB; color: #6B7280; }
        .action-mini-btn:hover { border-color: var(--brand-navy); color: var(--brand-navy); background: #EFF6FF; }
        .btn { padding: 8px 16px; border-radius: 50px; font-weight: 600; font-size: 0.85rem; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; white-space: nowrap; }
        .btn-primary { background-color: var(--brand-yellow); color: var(--brand-dark); }
        .btn-primary:hover { background-color: var(--brand-yellow-dark); }
        .btn-secondary { background-color: var(--brand-white); border: 1px solid var(--brand-border); color: var(--brand-dark); }
        .btn-secondary:hover { background-color: #F9FAFB; }

        /* COMPONENTS */
        .category-list { list-style: none; }
        .category-item { padding: 12px 15px; cursor: pointer; color: #4B5563; font-weight: 500; border-bottom: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .category-item:hover { background-color: #F9FAFB; }
        #subfamily-panel { display: none; }
        .subfamily-header { background: #EFF6FF; color: var(--brand-navy); padding: 10px 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; border-bottom: 1px solid var(--brand-border); }
        .article-item { padding: 8px 15px 8px 25px; font-size: 0.8rem; cursor: pointer; border-bottom: 1px dashed var(--brand-border); display: flex; justify-content: space-between; color: #374151; }
        .article-item:hover { background-color: #ECFDF5; color: #047857; }
        
        .room-nav { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .room-pill { background: white; border: 1px solid var(--brand-border); padding: 6px 14px; border-radius: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-width: 90px; position: relative; transition: all 0.2s; }
        .room-pill.active { background: var(--brand-yellow); border-color: #F59E0B; color: var(--brand-dark); box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2); }
        .delete-room-btn { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: var(--brand-danger); color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; border: 2px solid white; cursor: pointer; }
        .room-pill:hover .delete-room-btn, .room-pill.active .delete-room-btn { opacity: 1; }
        .room-pill.static-prep { background-color: #E5E7EB; border-color: #D1D5DB; color: #4B5563; font-weight: 600; cursor: pointer; }
        .room-pill.static-prep.active { background-color: #9CA3AF; color: white; border-color: #6B7280; }
        .room-pill.static-prep .delete-room-btn { display: none !important; }

        .metrics-panel { background: #FFFBEB; border: 1px solid #FCD34D; border-radius: var(--radius-sm); padding: 12px; display: flex; gap: 10px; align-items: flex-end; margin-bottom: 10px; flex-wrap: wrap; }
        .metrics-panel.hidden { display: none; }
        .m-group { display: flex; flex-direction: column; gap: 4px; }
        .m-group label { font-size: 0.65rem; text-transform: uppercase; font-weight: 700; color: #92400E; }
        .m-group input { width: 65px; padding: 5px; border: 1px solid #FDE68A; border-radius: 4px; text-align: right; background: white; font-size: 0.8rem; }
        .m-group input[readonly] { background: rgba(255, 255, 255, 0.5); border-color: transparent; font-weight: bold; color: #666; }
        .quote-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .quote-title { font-size: 1.1rem; font-weight: 700; color: var(--brand-navy); }
        .view-toggles button { background: white; border: 1px solid var(--brand-border); padding: 4px 10px; font-size: 0.75rem; cursor: pointer; border-radius: 4px; }
        .view-toggles button.active { background: var(--brand-navy); color: white; border-color: var(--brand-navy); }
        
        .q-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        .q-table th { text-align: left; padding: 10px; background: #F9FAFB; color: #6B7280; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; border-bottom: 1px solid var(--brand-border); }
        .q-table td { padding: 8px 10px; border-bottom: 1px solid var(--brand-border); vertical-align: middle; }
        .room-section-header td { background: #1E3A8A; color: white; font-weight: 800; font-size: 0.9rem; padding: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .category-row td { background: #EFF6FF; color: #1E3A8A; font-weight: 700; font-size: 0.85rem; padding-top: 10px; border-top: 1px solid #DBEAFE; }
        .subcategory-row td { color: #6B7280; font-weight: 600; font-size: 0.8rem; padding-left: 25px; font-style: italic; background: #F9FAFB; }
        .breakdown-badge { display: inline-block; background: #F3F4F6; border: 1px solid #E5E7EB; border-radius: 4px; padding: 2px 6px; font-size: 0.7rem; margin-right: 4px; margin-top: 2px; color: #4B5563; }

        .qty-inp { width: 50px; text-align: center; padding: 4px; border: 1px solid #D1D5DB; border-radius: 4px; }
        .tva-select { padding: 4px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.8rem; background: white; cursor: pointer; }
        .note-input { width: 100%; border: 1px solid transparent; background: transparent; font-size: 0.8rem; color: #4B5563; font-style: italic; padding: 4px; border-radius: 4px; }
        .note-input:focus { background: white; border: 1px solid #D1D5DB; font-style: normal; outline: none; }
        
        body.mode-brouillon .col-price, body.mode-brouillon .col-total, body.mode-brouillon .col-tva { display: none; }
        body.mode-devis .col-time, body.mode-devis .col-note { display: none; } 

        .client-info-box { margin-bottom: 20px; }
        .client-label { font-size: 0.7rem; color: #9CA3AF; text-transform: uppercase; margin-top: 8px; display: block; }
        .client-input { width: 100%; border: none; background: transparent; font-weight: 500; padding: 2px 0; border-bottom: 1px dashed transparent; color: var(--brand-dark); }
        .client-input:hover { border-bottom-color: #D1D5DB; background: #F9FAFB; }
        .total-box { background: #F8FAFC; border: 1px solid var(--brand-border); padding: 15px; border-radius: var(--radius-sm); margin-top: 20px; }
        .fin-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.85rem; }
        .fin-input { width: 80px; text-align: right; padding: 3px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.85rem; }
        .t-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; color: #4B5563; }
        .t-row.main-total { border-top: 2px solid #D1D5DB; padding-top: 10px; margin-top: 10px; font-size: 1.2rem; font-weight: 800; color: var(--brand-navy); }
        .tva-breakdown { font-size: 0.75rem; color: #666; margin: 10px 0; border-top: 1px dashed #ddd; border-bottom: 1px dashed #ddd; padding: 5px 0; }
        .tva-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .client-list-item { padding: 15px; border-bottom: 1px solid var(--brand-border); cursor: pointer; transition: background 0.2s; }
        .client-list-item:hover { background: #F9FAFB; }
        .cli-name { font-weight: 700; color: var(--brand-navy); font-size: 0.95rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 5px; }
        .form-group.full-width { grid-column: span 2; }
        .form-label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--brand-dark); margin-bottom: 4px; text-transform: uppercase; }
        .form-input { width: 100%; padding: 8px; border: 1px solid var(--brand-border); border-radius: 6px; font-size: 0.9rem; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 25000; display: none; align-items: center; justify-content: center; }
        .modal-large { background: white; padding: 0; border-radius: 12px; width: 90%; max-width: 800px; height: 90%; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--brand-border); display: flex; justify-content: space-between; align-items: center; background: #F9FAFB; }
        .modal-title-text { font-size: 1.25rem; font-weight: 800; color: var(--brand-navy); }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--brand-border); display: flex; justify-content: flex-end; gap: 10px; background: white; }
        .section-divider { margin: 25px 0 15px 0; border-bottom: 2px solid #F3F4F6; padding-bottom: 5px; color: var(--brand-navy); font-weight: 700; font-size: 1rem; }
        
        .room-grid-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .room-select-btn { padding: 10px; border: 1px solid var(--brand-border); border-radius: 8px; background: white; cursor: pointer; font-size: 0.9rem; text-align: center; transition: all 0.2s; }
        .room-select-btn:hover { background: #EFF6FF; border-color: var(--brand-navy); color: var(--brand-navy); }
        .room-select-btn.active { background: var(--brand-navy); color: white; border-color: var(--brand-navy); }

        .demo-search-box { margin-bottom: 15px; position: relative; }
        .demo-search-input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 0.95rem; }
        .demo-search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF; }
        .demo-list { list-style: none; max-height: 400px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 8px; }
        .demo-item { padding: 15px; border-bottom: 1px solid #F3F4F6; cursor: pointer; transition: background 0.15s; display: flex; justify-content: space-between; align-items: center; }
        .demo-item:hover { background-color: #F9FAFB; }
        .demo-item-content { flex: 1; }
        .demo-ref { font-size: 0.75rem; color: #6B7280; font-weight: 600; margin-bottom: 2px; }
        .demo-title { font-weight: 600; color: var(--brand-dark); font-size: 0.95rem; margin-bottom: 2px; }
        .demo-desc { font-size: 0.8rem; color: #6B7280; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .demo-price-tag { background: #ECFDF5; color: #047857; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 0.85rem; white-space: nowrap; margin-left: 15px; }
        
        #pdf-modal .modal-content { width: 400px; height: auto; }
        .pdf-option { display: block; width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #E5E7EB; border-radius: 8px; background: #F9FAFB; cursor: pointer; text-align: left; transition: all 0.2s; }
        .pdf-option:hover { background: #EFF6FF; border-color: var(--brand-navy); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 20000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--brand-yellow); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-bar { display: flex; gap: 15px; padding: 15px; background: white; border-bottom: 1px solid var(--brand-border); align-items: flex-end; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-input { padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 0.85rem; min-width: 150px; }
        
        @media print { .q-table tr { page-break-inside: avoid; } .category-row, .subcategory-row { page-break-after: avoid; } }
        @media (max-width: 900px) { .header-search-container { display: none; } .header-right-actions { display: none; } #quote-view { grid-template-columns: 1fr; } #quote-view aside:first-child { display: none; } .form-grid { grid-template-columns: 1fr; } .kpi-grid { grid-template-columns: 1fr 1fr; } .charts-grid { grid-template-columns: 1fr; } }
    </style>
</head>

<body class="mode-brouillon">

    <div id="login-screen">
        <div class="login-card">
            <div class="login-logo">Q</div>
            <h1 class="login-title">QOTIA Connect</h1>
            <form onsubmit="App.handleLogin(event)">
                <input type="text" id="login-user" class="login-input" placeholder="Identifiant (admin)" required>
                <input type="password" id="login-pass" class="login-input" placeholder="Mot de passe (admin)" required>
                <button type="submit" class="login-btn">Se Connecter</button>
            </form>
            <div style="margin-top:15px; font-size:0.8rem; color:#888;">Gestion BTP & Facturation</div>
        </div>
    </div>

    <div class="gs-overlay" id="gs-overlay" onclick="App.toggleGlobalMenu()"></div>
    <aside id="global-sidebar">
        <div class="gs-header">
            <div class="header-brand">
                <div class="logo-circle">Q</div>
                <div class="header-title">QOTIA</div>
            </div>
            <button class="global-menu-btn" onclick="App.toggleGlobalMenu()" aria-label="Close menu"><i class="fas fa-times"></i></button>
        </div>
        <nav class="gs-links">
            <div class="gs-link" onclick="App.navigate('home')"><i class="fas fa-home"></i> Accueil</div>
            <div class="gs-link" onclick="App.openProjectModal()"><i class="fas fa-plus-circle"></i> Nouveau Projet</div>
            <div class="gs-link" onclick="App.navigate('quote')"><i class="fas fa-edit"></i> Éditeur</div>
            <div class="gs-link" onclick="App.navigate('list')"><i class="fas fa-history"></i> Historique</div>
            <div class="gs-link" onclick="App.navigate('client')"><i class="fas fa-users"></i> Clients</div>
            <hr style="border-top:1px solid #eee; margin:5px 0;">
            <div class="gs-link" onclick="App.navigate('company')"><i class="fas fa-building"></i> Mon Entreprise</div>
            <div class="gs-link" onclick="App.openPdfModal()"><i class="fas fa-print"></i> Stampa</div>
            <div class="gs-link" onclick="App.handleLogout()" style="color:var(--brand-danger); margin-top:auto;"><i class="fas fa-sign-out-alt"></i> Déconnexion</div>
        </nav>
    </aside>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight:600; color:var(--brand-navy)">Chargement...</div>
    </div>

    <div class="app-container">
        <header class="top-header">
            <div class="header-left">
                <button class="global-menu-btn" onclick="App.toggleGlobalMenu()" aria-label="Open menu"><i class="fas fa-bars"></i></button>
                <div class="header-brand" onclick="App.showView('home')">
                    <div class="logo-circle">Q</div>
                    <div class="header-title">QOTIA</div>
                </div>
            </div>
            <div class="header-search-container">
                <div class="header-search-box">
                    <i class="fas fa-search header-search-icon"></i>
                    <input type="text" class="header-search-input" placeholder="Rechercher..." onkeyup="App.globalSearch(this.value)">
                </div>
            </div>
            <div class="header-right-actions">
                <button class="nav-link-btn" id="nav-list" onclick="App.showView('list')"><i class="fas fa-history"></i> Historique</button>
                <button class="nav-link-btn" id="nav-clients" onclick="App.showView('client')"><i class="fas fa-users"></i> Client</button>
                <button class="nav-link-btn btn-accent" onclick="App.openProjectModal()"><i class="fas fa-plus-circle"></i> +Projet</button>
            </div>
        </header>

        <main id="home-view" class="view-section active-section">
            <div class="dash-header">
                <div><h2 class="dash-title">Tableau de Bord</h2><div class="dash-subtitle">Bienvenue.</div></div>
                <div class="kpi-filter-box">
                    <select id="kpi-period" class="kpi-select" onchange="App.renderHome()">
                        <option value="all">Tout</option><option value="year" selected>Année</option><option value="month">Mois</option>
                    </select>
                </div>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon" style="background:#EFF6FF; color:#1E40AF;"><i class="fas fa-file-invoice"></i></div>
                    <div class="kpi-label">Total Devis</div>
                    <div class="kpi-value" id="kpi-total-count">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background:#F0F9FF; color:#0369A1;"><i class="fas fa-chart-line"></i></div>
                    <div class="kpi-label">CA Signé</div>
                    <div class="kpi-value" id="kpi-volume">0 €</div>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-box"><div class="chart-container"><canvas id="statusChart"></canvas></div></div>
                <div class="chart-box"><div class="chart-container"><canvas id="revenueChart"></canvas></div></div>
            </div>
        </main>

        <main id="list-view" class="view-section">
            <div class="card" style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                <div class="sidebar-title" style="font-size: 1.1rem; border-bottom: 1px solid #eee;">Historique</div>
                <div class="filter-bar">
                    <div class="filter-group"><label>Recherche</label><input type="text" id="dash-search" class="filter-input" onkeyup="App.renderDashboardList()"></div>
                    <button class="btn btn-secondary" onclick="App.renderDashboardList()"><i class="fas fa-sync"></i></button>
                </div>
                <div class="col-scroll" style="padding: 0;">
                    <table class="dash-table">
                        <thead><tr><th>Date</th><th>Réf.</th><th>Client</th><th>Montant</th><th>Statut</th><th>Action</th></tr></thead>
                        <tbody id="dashboard-tbody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <main id="quote-view" class="view-section">
            <aside class="col-scroll" id="left-sidebar">
                <div class="card" style="min-height: 100%;">
                    <div class="sidebar-title"><span id="lib-title-text">Bibliothèque</span></div>
                    <ul class="category-list" id="main-families-list"></ul>
                    <div id="subfamily-panel">
                        <div class="subfamily-header" id="back-to-families"><i class="fas fa-arrow-left"></i> Retour</div>
                        <div id="subcategories-container"></div>
                    </div>
                </div>
            </aside>

            <section class="workspace col-scroll">
                <div class="room-nav" id="room-list-container"></div>
                <div class="metrics-panel" id="metrics-panel">
                    <div class="m-group"><label>Long. (m)</label><input type="number" id="inp-L" step="0.01" oninput="App.calcMetrics()"></div>
                    <div class="m-group"><label>Larg. (m)</label><input type="number" id="inp-l" step="0.01" oninput="App.calcMetrics()"></div>
                    <div class="m-group"><label>H. (m)</label><input type="number" id="inp-h" step="0.01" value="2.70" oninput="App.calcMetrics()"></div>
                    <div class="m-group"><label>Surface (m²)</label><input type="text" id="out-surf" readonly></div>
                </div>
                <div class="card" style="padding: 15px;">
                    <div class="quote-header">
                        <div class="mode-switch-internal" id="quote-mode-switch">
                            <button class="mode-btn active" id="btn-brouillon" onclick="App.setMode('brouillon')">Étude</button>
                            <button class="mode-btn" id="btn-devis" onclick="App.setMode('devis')">Devis</button>
                        </div>
                        <button class="btn btn-secondary" onclick="App.openDemolitionModal()"><i class="fas fa-hammer"></i> Démolition</button>
                    </div>
                    <table class="q-table">
                        <thead>
                            <tr><th style="width:30%">Désignation</th><th>U</th><th>Qté</th><th class="col-price">P.U.</th><th class="col-total">Total</th><th class="col-time">Temps</th><th class="col-note">Note</th><th></th></tr>
                        </thead>
                        <tbody id="quote-tbody"></tbody>
                    </table>
                </div>
            </section>

            <aside class="col-scroll">
                <div class="card" style="padding: 15px;">
                    <div class="sidebar-title">Client & Projet</div>
                    <div class="client-info-box">
                        <label class="client-label">Client</label><input type="text" id="cli-name" class="client-input">
                        <label class="client-label">Projet</label><input type="text" id="cli-project-name" class="client-input">
                        <label class="client-label">Date</label><input type="date" id="cli-date" class="client-input">
                        <label class="client-label">Ref</label><input type="text" id="cli-ref" class="client-input" readonly>
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="App.addCurrentQuoteToHistory()">Sauvegarder</button>
                </div>
                <div class="card total-box">
                    <div class="sidebar-title">Total</div>
                    <div style="display:flex;align-items:center;margin-bottom:10px;">
                        <input type="checkbox" id="autoliquidation-chk" onchange="App.updateSummaries()"> <label style="font-size:0.8rem;margin-left:5px;">Autoliquidation</label>
                    </div>
                    <div id="financial-summary-body"></div>
                    <div class="t-row" style="font-weight:700;color:#059669;margin-top:10px;"><span>Reste à Payer</span><span id="final-to-pay">0.00 €</span></div>
                </div>
            </aside>
        </main>

        <main id="client-view" class="view-section">
            <aside class="col-scroll">
                <div class="card" style="height:100%">
                    <div class="sidebar-title">Clients <button class="btn-secondary" onclick="App.newClient()">+</button></div>
                    <div id="client-list"></div>
                </div>
            </aside>
            <section class="col-scroll">
                <div class="card" style="padding:25px">
                    <h2>Fiche Client</h2>
                    <div class="type-switch" style="display:flex; gap:10px; margin-bottom:20px;">
                        <button class="type-btn active" id="btn-physique" onclick="App.setClientType('physique')">Physique</button>
                        <button class="type-btn" id="btn-morale" onclick="App.setClientType('morale')">Morale</button>
                    </div>
                    <form id="client-form" class="form-grid">
                        <input type="hidden" id="c-id">
                        <div class="form-group full-width grp-morale" style="display:none"><label class="form-label">Société</label><input type="text" id="c-company" class="form-input"></div>
                        <div class="form-group grp-physique"><label class="form-label">Nom</label><input type="text" id="c-lastname" class="form-input"></div>
                        <div class="form-group grp-physique"><label class="form-label">Prénom</label><input type="text" id="c-firstname" class="form-input"></div>
                        <div class="form-group full-width"><label class="form-label">Email</label><input type="email" id="c-email" class="form-input"></div>
                        <div class="form-group full-width"><label class="form-label">Adresse</label><input type="text" id="c-addr" class="form-input"></div>
                    </form>
                    <button class="btn btn-primary" onclick="App.saveClientToDB()" style="margin-top:20px;">Enregistrer</button>
                </div>
            </section>
        </main>

        <main id="company-view" class="view-section">
            <div class="col-scroll">
                <div class="card" style="padding:30px">
                    <h2>Mon Entreprise</h2>
                    <div class="form-grid">
                        <div class="form-group full-width"><label class="form-label">Nom</label><input type="text" id="user-company" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Admin User</label><input type="text" id="admin-user" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Admin Pass</label><input type="text" id="admin-pass" class="form-input"></div>
                    </div>
                    <button class="btn btn-primary" onclick="App.saveUserCompanyData()" style="margin-top:20px;">Sauvegarder</button>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="project-modal">
        <div class="modal-large">
            <div class="modal-header"><span class="modal-title-text">Nouveau Projet</span><button onclick="Utils.el('project-modal').style.display='none'">X</button></div>
            <div class="modal-body">
                <label class="form-label">Client</label>
                <select id="proj-client-select" class="form-input" onchange="ProjectService.handleClientSelection(this.value)"></select>
                <div id="proj-new-client-form" class="form-grid" style="margin-top:10px; border:1px solid #eee; padding:10px; display:none;">
                    <div class="form-group"><label>Nom</label><input type="text" id="proj-c-lastname" class="form-input"></div>
                </div>
                <label class="form-label" style="margin-top:10px;">Nom Projet</label>
                <input type="text" id="proj-name" class="form-input">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="ProjectService.createFullProjectStack()">Créer</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="room-selection-modal">
        <div class="modal-large" style="max-width:600px; height:auto;">
            <div class="modal-header"><span>Ajouter Pièce</span><button onclick="Utils.el('room-selection-modal').style.display='none'">X</button></div>
            <div class="modal-body">
                <div class="room-grid-selector" id="room-grid"></div>
                <input type="text" id="room-precision-input" class="form-input" placeholder="Précision (ex: Sud)" style="margin-top:10px;">
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="App.confirmAddRoom()">Ajouter</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="demo-modal">
        <div class="modal-large">
            <div class="modal-header"><span>Démolition</span><button onclick="Utils.el('demo-modal').style.display='none'">X</button></div>
            <div class="modal-body">
                <input type="text" id="demo-search-input" class="demo-search-input" placeholder="Recherche..." onkeyup="App.filterDemolitionList()">
                <ul class="demo-list" id="demo-list-container"></ul>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="pdf-modal">
        <div class="modal-content" style="background:white; padding:20px; border-radius:10px;">
            <div style="font-weight:bold; margin-bottom:10px;">Export PDF</div>
            <button class="pdf-option" onclick="PDFService.generate('devis')">Devis</button>
            <button class="pdf-option" onclick="PDFService.generate('facture')">Facture</button>
            <button class="btn btn-secondary" onclick="Utils.el('pdf-modal').style.display='none'" style="width:100%">Fermer</button>
        </div>
    </div>

    <script>
    /**
     * QOTIA ENGINE - FULL RESTORED
     */
    
    // --- CONSTANTS ---
    const Config = { LIBRARY_URL: 'library.json', DEFAULT_ROOM_HEIGHT: 2.70, HOURLY_RATE: 50 };
    const PREDEFINED_ROOMS = ["Entrée", "Séjour", "Salon", "Cuisine", "Chambre", "SDB", "WC", "Couloir", "Autre"];
    
    // Fallback Data if library.json fails
    const DEFAULT_LIBRARY = {
        categories: {
            "Installation": { icon: "fa-hard-hat", subs: ["Protection", "Echafaudage"] },
            "Démolition": { icon: "fa-hammer", subs: ["Cloisons", "Sols", "Evacuation"] },
            "Plâtrerie": { icon: "fa-layer-group", subs: ["Cloisons", "Doublages"] },
            "Peinture": { icon: "fa-paint-roller", subs: ["Murs", "Plafonds"] }
        },
        demolition_db: [
            { ref: "DEM-01", title: "Démolition Cloison", desc: "Manuelle", unit: "m2", time: 0.5, mat: 0 },
            { ref: "DEM-02", title: "Dépose Carrelage", desc: "Au sol", unit: "m2", time: 0.8, mat: 0 }
        ]
    };

    let CATEGORY_MAP = {}; 
    let DEMOLITION_DB = [];

    // --- UTILS ---
    const Utils = {
        el: (id) => document.getElementById(id),
        val: (id) => document.getElementById(id)?.value || '',
        setVal: (id, val) => { const el = document.getElementById(id); if (el) el.value = val; },
        generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2)
    };

    // --- STORE ---
    const Store = {
        data: {
            rooms: ["Travaux préparatoires"],
            activeRoom: "Travaux préparatoires",
            roomData: {},
            quoteItems: [],
            clientsDB: [], 
            projectsDB: [], 
            currentClient: null,
            userCompany: { name: 'Mon Entreprise', adminUser: 'admin', adminPass: 'admin' },
            globalDiscount: 0,
            depositAmount: 0
        },
        save() { 
            this.data.clientInfo = { name: Utils.val('cli-name'), projectName: Utils.val('cli-project-name'), date: Utils.val('cli-date'), ref: Utils.val('cli-ref') };
            localStorage.setItem('qotia_state', JSON.stringify(this.data)); 
        },
        load() {
            const saved = localStorage.getItem('qotia_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    this.data = { ...this.data, ...parsed };
                    if(!this.data.userCompany.adminUser) this.data.userCompany.adminUser = 'admin';
                } catch(e) { console.error(e); }
            }
        }
    };

    // --- BUSINESS LOGIC ---
    const BusinessLogic = {
        calcFin(items, disc, dep, autoLiq) {
            let ht = 0, time = 0;
            items.forEach(i => { ht += i.qty * i.price; time += i.qty * i.time; });
            let discHT = ht * (1 - disc/100);
            let tva = 0;
            if(!autoLiq) items.forEach(i => { tva += (i.qty * i.price * (1-disc/100)) * i.tva; });
            return { totalHT: ht, totalTime: time, discountedHT: discHT, totalTVA: tva, totalTTC: discHT + tva, toPay: (discHT + tva) - dep };
        },
        getQuotes(clients) {
            let all = [];
            clients.forEach(c => c.quotes?.forEach((q, idx) => all.push({ cId: c.id, qIdx: idx, cName: c.type==='morale'?c.company:c.lastname, ...q })));
            return all.sort((a,b) => new Date(b.date) - new Date(a.date));
        }
    };

    // --- APP CONTROLLER ---
    const App = {
        currentMode: 'brouillon',
        currentView: 'piece',
        selectedRoomType: null,
        chartInstances: {},

        async init() {
            this.checkLogin();
            Store.load();
            await this.loadLib();
            Utils.setVal('cli-date', new Date().toISOString().split('T')[0]);
            this.renderAll();
            this.renderClientList();
            this.renderHome();
            this.renderDashboardList();
            Utils.el('loading-overlay').style.display = 'none';
        },

        async loadLib() {
            try {
                const res = await fetch(Config.LIBRARY_URL);
                if(!res.ok) throw new Error();
                const d = await res.json();
                CATEGORY_MAP = d.categories; DEMOLITION_DB = d.demolition_db;
            } catch(e) {
                CATEGORY_MAP = DEFAULT_LIBRARY.categories; DEMOLITION_DB = DEFAULT_LIBRARY.demolition_db;
            }
            this.renderCategories();
        },

        checkLogin() { Utils.el('login-screen').style.display = sessionStorage.getItem('q_auth') ? 'none' : 'flex'; },
        handleLogin(e) {
            e.preventDefault();
            if(Utils.val('login-user') === Store.data.userCompany.adminUser && Utils.val('login-pass') === Store.data.userCompany.adminPass) {
                sessionStorage.setItem('q_auth', 'true'); Utils.el('login-screen').style.display = 'none';
            } else alert("Erreur (admin/admin)");
        },
        handleLogout() { sessionStorage.removeItem('q_auth'); location.reload(); },

        // NAVIGATION
        toggleGlobalMenu() { Utils.el('global-sidebar').classList.toggle('open'); Utils.el('gs-overlay').classList.toggle('active'); },
        toggleSidebar() { Utils.el('left-sidebar').classList.toggle('mobile-active'); },
        navigate(v) { this.showView(v); this.toggleGlobalMenu(); },
        showView(v) {
            document.querySelectorAll('.view-section').forEach(x => x.classList.remove('active-section'));
            Utils.el(v + '-view').classList.add('active-section');
            if(v === 'home') this.renderHome();
            if(v === 'list') this.renderDashboardList();
        },

        // ROOMS
        addNewRoom() {
            const grid = Utils.el('room-grid'); grid.innerHTML = '';
            PREDEFINED_ROOMS.forEach(r => {
                const b = document.createElement('div'); b.className = 'room-select-btn'; b.innerText = r;
                b.onclick = () => { document.querySelectorAll('.room-select-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); this.selectedRoomType = r; };
                grid.appendChild(b);
            });
            Utils.el('room-selection-modal').style.display = 'flex';
        },
        confirmAddRoom() {
            if(!this.selectedRoomType) return;
            const name = this.selectedRoomType + (Utils.val('room-precision-input') ? ` (${Utils.val('room-precision-input')})` : '');
            if(!Store.data.rooms.includes(name)) {
                Store.data.rooms.push(name); Store.data.roomData[name] = { L:0, l:0, h:2.7 };
                this.switchRoom(name); Store.save();
            }
            Utils.el('room-selection-modal').style.display = 'none';
        },
        switchRoom(r) { Store.data.activeRoom = r; this.renderAll(); },
        deleteRoom(e, r) {
            e.stopPropagation();
            if(r === "Travaux préparatoires" || !confirm("Supprimer?")) return;
            Store.data.rooms = Store.data.rooms.filter(x => x !== r);
            Store.data.quoteItems = Store.data.quoteItems.filter(i => i.piece !== r);
            this.switchRoom(Store.data.rooms[0]); Store.save();
        },
        renderRooms() {
            const c = Utils.el('room-list-container'); c.innerHTML = '';
            Store.data.rooms.forEach(r => {
                const d = document.createElement('div');
                d.className = `room-pill ${r === Store.data.activeRoom ? 'active' : ''} ${r === "Travaux préparatoires" ? 'static-prep' : ''}`;
                d.innerHTML = `<span class="r-name">${r}</span>${r !== "Travaux préparatoires" ? '<div class="delete-room-btn"><i class="fas fa-times"></i></div>' : ''}`;
                d.onclick = (e) => { if(!e.target.closest('.delete-room-btn')) this.switchRoom(r); };
                if(r !== "Travaux préparatoires") d.querySelector('.delete-room-btn').onclick = (e) => this.deleteRoom(e, r);
                c.appendChild(d);
            });
            const add = document.createElement('div'); add.className = 'room-pill'; add.innerHTML = '+'; add.onclick = () => this.addNewRoom();
            c.appendChild(add);
        },

        // METRICS
        loadMetrics() {
            const d = Store.data.roomData[Store.data.activeRoom];
            if(d) { Utils.setVal('inp-L', d.L); Utils.setVal('inp-l', d.l); Utils.setVal('inp-h', d.h); this.calcMetrics(false); }
            Utils.el('metrics-panel').classList.toggle('hidden', Store.data.activeRoom === "Travaux préparatoires");
        },
        calcMetrics(save=true) {
            const r = Store.data.activeRoom;
            if(r === "Travaux préparatoires") return;
            const L = parseFloat(Utils.val('inp-L'))||0, l = parseFloat(Utils.val('inp-l'))||0, h = parseFloat(Utils.val('inp-h'))||0;
            Store.data.roomData[r] = { L, l, h };
            Utils.setVal('out-surf', (L*l).toFixed(2));
            if(save) Store.save();
        },

        // LIBRARY
        renderCategories() {
            const l = Utils.el('main-families-list'); l.innerHTML = '';
            Object.entries(CATEGORY_MAP).forEach(([k, v]) => {
                const li = document.createElement('li'); li.className = 'category-item';
                li.innerHTML = `<span><i class="fas ${v.icon}"></i> ${k}</span> <i class="fas fa-chevron-right"></i>`;
                li.onclick = () => this.showSub(k);
                l.appendChild(li);
            });
        },
        showSub(cat) {
            Utils.el('main-families-list').style.display = 'none';
            Utils.el('subfamily-panel').style.display = 'block';
            Utils.el('back-to-families').onclick = () => { Utils.el('subfamily-panel').style.display = 'none'; Utils.el('main-families-list').style.display = 'block'; };
            const c = Utils.el('subcategories-container'); c.innerHTML = '';
            CATEGORY_MAP[cat].subs.forEach(s => {
                const d = document.createElement('div'); d.className = 'article-item';
                d.innerHTML = `<span>${s}</span> <i class="fas fa-plus"></i>`;
                d.onclick = () => this.addItem(cat, s, `Ouvrage ${s}`);
                c.appendChild(d);
            });
        },
        addItem(fam, sub, desc, unit='m²', price=30, time=0.5, mat=0) {
            Store.data.quoteItems.push({ id: Date.now(), piece: Store.data.activeRoom, fam, sub, desc, unit, qty: 1, price, time, matCost: mat, matIsTotal: false, tva: 0.1, note: '' });
            this.renderAll(); Store.save();
        },
        updateItem(id, f, v) {
            const i = Store.data.quoteItems.find(x => x.id === id);
            if(i) { i[f] = (f === 'note' ? v : parseFloat(v)); this.renderAll(); Store.save(); }
        },
        deleteItem(id) { Store.data.quoteItems = Store.data.quoteItems.filter(x => x.id !== id); this.renderAll(); Store.save(); },
        toggleMatType(id) {
            const i = Store.data.quoteItems.find(x => x.id === id);
            if(i) { i.matIsTotal = !i.matIsTotal; this.renderAll(); Store.save(); }
        },

        // DEMOLITION
        openDemolitionModal() { Utils.el('demo-modal').style.display = 'flex'; this.filterDemolitionList(); },
        filterDemolitionList() {
            const t = Utils.val('demo-search-input').toLowerCase();
            const l = Utils.el('demo-list-container'); l.innerHTML = '';
            DEMOLITION_DB.forEach(i => {
                if(i.title.toLowerCase().includes(t)) {
                    const li = document.createElement('li'); li.className = 'demo-item';
                    li.innerHTML = `<div class="demo-item-content"><div class="demo-title">${i.title}</div><div class="demo-desc">${i.desc}</div></div><div class="demo-price-tag">${(i.time*50+i.mat).toFixed(2)}€</div>`;
                    li.onclick = () => { this.addItem('Démolition', 'Interne', i.title, i.unit, i.time*50+i.mat, i.time, i.mat); Utils.el('demo-modal').style.display='none'; };
                    l.appendChild(li);
                }
            });
        },

        // RENDERING
        renderAll() { this.renderRooms(); this.loadMetrics(); this.renderTable(); this.updateSummaries(); },
        renderTable() {
            const tb = Utils.el('quote-tbody'); tb.innerHTML = '';
            const items = Store.data.quoteItems.filter(i => i.piece === Store.data.activeRoom);
            if(items.length === 0) { tb.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:20px;color:#ccc">Vide</td></tr>`; return; }
            
            // Grouping logic simple
            const fams = [...new Set(items.map(i => i.fam))];
            fams.forEach(f => {
                tb.innerHTML += `<tr class="category-row"><td colspan="10">${f}</td></tr>`;
                items.filter(i => i.fam === f).forEach(i => {
                    let matBtn = i.matIsTotal ? 'Tot' : '/u';
                    tb.innerHTML += `<tr>
                        <td>${i.desc}</td><td>${i.unit}</td>
                        <td><input type="number" class="qty-inp" value="${i.qty}" onchange="App.updateItem(${i.id},'qty',this.value)"></td>
                        <td class="col-tva">${(i.tva*100).toFixed(0)}%</td>
                        <td class="col-price">${i.price}€</td>
                        <td class="col-cost"><input type="number" class="qty-inp" value="${i.matCost}" onchange="App.updateItem(${i.id},'matCost',this.value)"> <button onclick="App.toggleMatType(${i.id})">${matBtn}</button></td>
                        <td class="col-total"><strong>${(i.qty*i.price).toFixed(2)}€</strong></td>
                        <td class="col-time">${i.time}h</td>
                        <td class="col-note"><input type="text" class="note-input" value="${i.note}" onchange="App.updateItem(${i.id},'note',this.value)"></td>
                        <td><button onclick="App.deleteItem(${i.id})">X</button></td>
                    </tr>`;
                });
            });
        },
        updateSummaries() {
            const fin = BusinessLogic.calcFin(Store.data.quoteItems, Store.data.globalDiscount, Store.data.depositAmount, Utils.el('autoliquidation-chk')?.checked);
            Utils.el('financial-summary-body').innerHTML = `<div class="t-row"><span>Total HT</span><span>${fin.totalHT.toFixed(2)}€</span></div><div class="t-row main-total"><span>TTC</span><span>${fin.totalTTC.toFixed(2)}€</span></div>`;
            Utils.el('final-to-pay').innerText = fin.toPay.toFixed(2) + ' €';
        },
        setMode(m) { this.currentMode = m; document.body.className = `mode-${m}`; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); Utils.el(`btn-${m}`).classList.add('active'); },

        // CLIENTS & PROJECTS
        newClient() { Utils.el('client-form').reset(); Utils.setVal('c-id', ''); this.setClientType('physique'); },
        setClientType(t) {
            Utils.el('btn-physique').className = t==='physique'?'type-btn active':'type-btn';
            Utils.el('btn-morale').className = t==='morale'?'type-btn active':'type-btn';
            document.querySelectorAll('.grp-morale').forEach(e=>e.style.display=t==='morale'?'block':'none');
            document.querySelectorAll('.grp-physique').forEach(e=>e.style.display=t==='morale'?'none':'block');
        },
        saveClientToDB() {
            const id = Utils.val('c-id') || Date.now();
            const type = Utils.el('btn-morale').classList.contains('active') ? 'morale' : 'physique';
            const c = { id, type, lastname: Utils.val('c-lastname'), firstname: Utils.val('c-firstname'), company: Utils.val('c-company'), email: Utils.val('c-email'), addr: Utils.val('c-addr'), quotes: [] };
            Store.data.clientsDB.push(c); Store.save(); this.renderClientList(); alert("Client OK");
        },
        renderClientList() {
            const l = Utils.el('client-list'); l.innerHTML = '';
            Store.data.clientsDB.forEach(c => {
                const d = document.createElement('div'); d.className = 'client-list-item';
                d.innerHTML = `<span class="cli-name">${c.type==='morale'?c.company:c.lastname}</span>`;
                d.onclick = () => { Store.data.currentClient = c; Utils.setVal('c-id', c.id); Utils.setVal('c-lastname', c.lastname); };
                l.appendChild(d);
            });
        },
        openProjectModal() { ProjectService.init(); Utils.el('project-modal').style.display = 'flex'; },
        addCurrentQuoteToHistory() {
            if(!Store.data.currentClient) return alert("Select Client first");
            const q = { ref: Utils.val('cli-ref'), date: Utils.val('cli-date'), amount: parseFloat(Utils.el('final-to-pay').innerText), status: 'brouillon', data: JSON.parse(JSON.stringify(Store.data)) };
            Store.data.currentClient.quotes.push(q); Store.save(); alert("Sauvegardé");
        },

        // DASHBOARD
        renderHome() {
            const qs = BusinessLogic.getQuotes(Store.data.clientsDB);
            Utils.el('kpi-total-count').innerText = qs.length;
            const ca = qs.filter(q=>q.status==='accepte').reduce((a,b)=>a+b.amount,0);
            Utils.el('kpi-volume').innerText = ca.toFixed(2) + ' €';
            
            // Charts
            new Chart(Utils.el('statusChart'), { type: 'doughnut', data: { labels: ['Devis'], datasets: [{ data: [qs.length], backgroundColor: ['#1E3A8A'] }] } });
        },
        renderDashboardList() {
            const t = Utils.el('dashboard-tbody'); t.innerHTML = '';
            BusinessLogic.getQuotes(Store.data.clientsDB).forEach(q => {
                t.innerHTML += `<tr><td>${q.date}</td><td>${q.ref}</td><td>${q.cName}</td><td>${q.amount}€</td><td>${q.status}</td><td><button onclick="App.loadQuote(${q.cId},${q.qIdx})">Edit</button></td></tr>`;
            });
        },
        loadQuote(cId, idx) {
            const c = Store.data.clientsDB.find(x=>x.id==cId);
            const q = c.quotes[idx];
            Store.data = q.data; Store.data.currentClient = c;
            this.renderAll(); this.showView('quote');
        },
        
        saveUserCompanyData() {
            Store.data.userCompany.name = Utils.val('user-company');
            Store.data.userCompany.adminUser = Utils.val('admin-user');
            Store.data.userCompany.adminPass = Utils.val('admin-pass');
            Store.save(); alert("Info Saved");
        }
    };

    const ProjectService = {
        init() {
            const s = Utils.el('proj-client-select'); s.innerHTML = '<option value="new">Nouveau</option>';
            Store.data.clientsDB.forEach(c => { const o = document.createElement('option'); o.value=c.id; o.innerText=c.lastname; s.appendChild(o); });
            Utils.el('proj-new-client-form').style.display = 'block';
        },
        handleClientSelection(v) { Utils.el('proj-new-client-form').style.display = v==='new'?'block':'none'; },
        createFullProjectStack() {
            const name = Utils.val('proj-name');
            const ref = BusinessLogic.generateNextRef(Store.data.clientsDB);
            Utils.setVal('cli-project-name', name); Utils.setVal('cli-ref', ref);
            Utils.el('project-modal').style.display = 'none';
            App.showView('quote');
        }
    };

    const PDFService = { generate() { window.print(); } };

    window.App = App; window.ProjectService = ProjectService; window.PDFService = PDFService;
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
