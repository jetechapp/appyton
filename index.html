<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="QOTIA - Gestion & Devis BTP">
    <title>QOTIA | Gestion & Devis BTP (Pro 2025)</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- VARIABILI & RESET --- */
        :root {
            --brand-yellow: #FCD34D;
            --brand-yellow-dark: #F59E0B;
            --brand-navy: #1E3A8A;
            --brand-dark: #1F2937;
            --brand-grey-bg: #F3F4F6;
            --brand-white: #FFFFFF;
            --brand-border: #E5E7EB;
            --brand-danger: #EF4444;
            --brand-success: #10B981;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --header-height: 64px;
            --sidebar-width: 280px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; outline: none; }
        body { background-color: var(--brand-grey-bg); color: var(--brand-dark); line-height: 1.5; font-size: 13px; height: 100vh; overflow: hidden; }
        
        /* UTILITIES */
        .responsive-text { display: none; }
        @media(min-width: 600px) { .responsive-text { display: inline; } }
        .text-bold { font-weight: 700; }
        .text-navy { color: var(--brand-navy); }
        .w-full { width: 100%; }
        .mb-2 { margin-bottom: 0.5rem; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--brand-navy); z-index: 50000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-card { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        .login-logo { width: 60px; height: 60px; background: var(--brand-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 800; color: white; margin: 0 auto 20px; }
        .login-title { font-size: 1.5rem; font-weight: 800; color: var(--brand-navy); margin-bottom: 20px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--brand-border); border-radius: 8px; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background: var(--brand-navy); color: white; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .login-btn:hover { background: #1e40af; }

        /* --- LAYOUT PRINCIPALE CON HEADER FISSO --- */
        .app-container { 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            padding-top: var(--header-height);
        }
        
        .top-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: var(--header-height);
            background-color: var(--brand-white); 
            border-bottom: 1px solid var(--brand-border); 
            padding: 0 24px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-shrink: 0; 
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        /* --- SEARCH BAR --- */
        .header-search-container {
            flex: 1;
            display: flex;
            justify-content: center;
            margin: 0 20px;
            max-width: 500px;
        }
        .header-search-box {
            position: relative;
            width: 100%;
        }
        .header-search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 50px;
            border: 1px solid var(--brand-border);
            background: #F3F4F6;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s ease-in-out;
        }
        .header-search-input:focus {
            background: white;
            border-color: var(--brand-navy);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        .header-search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            pointer-events: none;
        }
        @media (max-width: 900px) {
            .header-search-container { display: none; }
        }

        /* HEADER ELEMENTS & UNIFIED NAVIGATION */
        .header-left { display: flex; align-items: center; gap: 15px; }
        .global-menu-btn { background: transparent; border: none; font-size: 1.2rem; color: var(--brand-navy); cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s; }
        .global-menu-btn:hover { background: #F3F4F6; }
        .header-brand { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logo-circle { width: 32px; height: 32px; background: var(--brand-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .header-title { font-weight: 800; color: var(--brand-navy); font-size: 18px; letter-spacing: -0.5px; }
        
        .header-right-actions { display: flex; gap: 10px; align-items: center; }
        
        .nav-link-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 8px;
            color: #4B5563;
            background: transparent;
            border: 1px solid transparent;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        .nav-link-btn:hover { background: #F3F4F6; color: var(--brand-navy); }
        .nav-link-btn.active { background: #EFF6FF; color: var(--brand-navy); }
        .nav-link-btn i { font-size: 1rem; }
        .nav-link-btn.btn-accent { color: var(--brand-navy); }

        .mode-switch-internal { background: #fff; padding: 3px; border-radius: 50px; display: inline-flex; border: 1px solid var(--brand-border); margin-left: 10px; }
        .mode-btn { padding: 4px 10px; border-radius: 40px; border: none; background: transparent; font-size: 10px; font-weight: 600; cursor: pointer; color: #6B7280; }
        .mode-btn.active { background: var(--brand-grey-bg); color: var(--brand-navy); }

        /* SIDEBAR */
        #global-sidebar { position: fixed; top: 0; left: -300px; width: 260px; height: 100%; background: white; z-index: 2000; border-right: 1px solid var(--brand-border); transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: 10px 0 25px rgba(0,0,0,0.05); }
        #global-sidebar.open { left: 0; }
        .gs-header { height: 64px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--brand-border); justify-content: space-between; }
        .gs-links { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .gs-link { padding: 12px 15px; border-radius: 8px; color: #4B5563; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; }
        .gs-link:hover { background: #F3F4F6; color: var(--brand-navy); }
        .gs-link.active { background: #EFF6FF; color: var(--brand-navy); }
        .gs-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1999; display: none; }
        .gs-overlay.active { display: block; }

        /* VIEWS & CONTENT */
        .view-section { display: none; height: calc(100vh - 64px); position: relative; }
        .view-section.active-section { display: grid; }
        #home-view { display: none; padding: 25px; overflow-y: auto; background: var(--brand-grey-bg); }
        #home-view.active-section { display: block; }
        .dash-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end; }
        .dash-title { font-size: 1.8rem; font-weight: 800; color: var(--brand-navy); margin-bottom: 5px; }
        .dash-subtitle { color: #6B7280; font-size: 0.9rem; }
        .kpi-filter-box { display: flex; align-items: center; gap: 10px; background: white; padding: 5px 10px; border-radius: 8px; border: 1px solid var(--brand-border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-select { border: none; font-weight: 600; color: var(--brand-navy); font-size: 0.9rem; cursor: pointer; padding: 5px; outline: none; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        
        .kpi-card { background: white; padding: 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-card); border: 1px solid var(--brand-border); display: flex; flex-direction: column; position: relative; }
        .kpi-card.clickable { cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
        .kpi-card.clickable:hover { transform: translateY(-2px); border-color: var(--brand-navy); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .kpi-card.clickable:active { transform: translateY(0); }

        .kpi-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 15px; }
        .kpi-label { font-size: 0.8rem; font-weight: 600; color: #6B7280; text-transform: uppercase; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--brand-dark); margin-top: 5px; }
        .kpi-sub { font-size: 0.8rem; color: #9CA3AF; margin-top: auto; padding-top: 10px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-card); border: 1px solid var(--brand-border); display: flex; flex-direction: column; height: 320px; }
        .chart-container { flex: 1; position: relative; width: 100%; min-height: 0; }
        .action-grid { display: block; margin-bottom: 20px; }
        .section-box { background: white; border-radius: var(--radius-md); border: 1px solid var(--brand-border); overflow: hidden; box-shadow: var(--shadow-card); }
        .box-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--brand-navy); background: #F9FAFB; }
        #list-view { grid-template-columns: 1fr; padding: 20px; background: var(--brand-grey-bg); overflow-y: auto; }
        
        /* EDITOR LAYOUT */
        #quote-view { grid-template-columns: var(--sidebar-width) 1fr 340px; gap: 20px; padding: 20px; overflow: hidden; }
        #client-view { grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; background: var(--brand-grey-bg); overflow: hidden; }
        #company-view { display: none; grid-template-columns: 1fr; max-width: 800px; margin: 0 auto; padding: 40px 20px; overflow-y: auto; }
        #company-view.active-section { display: block; }
        
        .col-scroll { overflow-y: auto; height: 100%; padding-right: 5px; padding-bottom: 20px; }
        .col-scroll::-webkit-scrollbar { width: 6px; }
        .col-scroll::-webkit-scrollbar-thumb { background-color: #D1D5DB; border-radius: 10px; }
        
        /* TABLES */
        .dash-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .dash-table th { text-align: left; padding: 12px 15px; background: #fff; color: #6B7280; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; border-bottom: 1px solid var(--brand-border); }
        .dash-table td { padding: 12px 15px; border-bottom: 1px solid var(--brand-border); vertical-align: middle; color: #374151; }
        .dash-table tr:hover { background: #F9FAFB; }
        .status-select-table { border: 1px solid transparent; border-radius: 15px; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; cursor: pointer; outline: none; }
        .status-select-table.st-brouillon { background: #F3F4F6; color: #374151; border-color: #E5E7EB; }
        .status-select-table.st-attente { background: #FFF7ED; color: #C2410C; border-color: #FFEDD5; }
        .status-select-table.st-accepte { background: #ECFDF5; color: #047857; border-color: #A7F3D0; }
        .status-select-table.st-refuse { background: #FEF2F2; color: #B91C1C; border-color: #FECACA; }
        .action-btn-group { display: flex; gap: 5px; justify-content: center; }
        .action-mini-btn { width: 30px; height: 30px; border-radius: 6px; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; background: white; border-color: #E5E7EB; color: #6B7280; }
        .action-mini-btn:hover { border-color: var(--brand-navy); color: var(--brand-navy); background: #EFF6FF; }
        .btn-del:hover { border-color: var(--brand-danger); color: var(--brand-danger); background: #FEF2F2; }
        .btn { padding: 8px 16px; border-radius: 50px; font-weight: 600; font-size: 0.85rem; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; white-space: nowrap; }
        .btn-primary { background-color: var(--brand-yellow); color: var(--brand-dark); }
        .btn-primary:hover { background-color: var(--brand-yellow-dark); }
        .btn-secondary { background-color: var(--brand-white); border: 1px solid var(--brand-border); color: var(--brand-dark); }
        .btn-secondary:hover { background-color: #F9FAFB; }

        /* COMPONENTS */
        .card { background: var(--brand-white); border-radius: var(--radius-md); box-shadow: var(--shadow-card); border: 1px solid var(--brand-border); overflow: hidden; margin-bottom: 20px; }
        .sidebar-title { padding: 15px; font-weight: 700; color: var(--brand-navy); border-bottom: 1px solid var(--brand-border); font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .category-list { list-style: none; }
        .category-item { padding: 12px 15px; cursor: pointer; color: #4B5563; font-weight: 500; border-bottom: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .category-item:hover { background-color: #F9FAFB; }
        #subfamily-panel { display: none; }
        .subfamily-header { background: #EFF6FF; color: var(--brand-navy); padding: 10px 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; border-bottom: 1px solid var(--brand-border); }
        .article-item { padding: 8px 15px 8px 25px; font-size: 0.8rem; cursor: pointer; border-bottom: 1px dashed var(--brand-border); display: flex; justify-content: space-between; color: #374151; }
        .article-item:hover { background-color: #ECFDF5; color: #047857; }
        
        /* ROOM PILLS AGGIORNATE */
        .room-nav { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .room-pill { background: white; border: 1px solid var(--brand-border); padding: 6px 14px; border-radius: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-width: 90px; position: relative; transition: all 0.2s; }
        .room-pill.active { background: var(--brand-yellow); border-color: #F59E0B; color: var(--brand-dark); box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2); }
        .delete-room-btn { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: var(--brand-danger); color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; border: 2px solid white; cursor: pointer; }
        .room-pill:hover .delete-room-btn, .room-pill.active .delete-room-btn { opacity: 1; }
        
        /* Special Style for Travaux Préparatoires */
        .room-pill.static-prep { background-color: #E5E7EB; border-color: #D1D5DB; color: #4B5563; font-weight: 600; cursor: pointer; }
        .room-pill.static-prep.active { background-color: #9CA3AF; color: white; border-color: #6B7280; }
        .room-pill.static-prep .delete-room-btn { display: none !important; }

        .metrics-panel { background: #FFFBEB; border: 1px solid #FCD34D; border-radius: var(--radius-sm); padding: 12px; display: flex; gap: 10px; align-items: flex-end; margin-bottom: 10px; flex-wrap: wrap; }
        .metrics-panel.hidden { display: none; }
        .m-group { display: flex; flex-direction: column; gap: 4px; }
        .m-group label { font-size: 0.65rem; text-transform: uppercase; font-weight: 700; color: #92400E; }
        .m-group input { width: 65px; padding: 5px; border: 1px solid #FDE68A; border-radius: 4px; text-align: right; background: white; font-size: 0.8rem; }
        .m-group input[readonly] { background: rgba(255, 255, 255, 0.5); border-color: transparent; font-weight: bold; color: #666; }
        .quote-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .quote-title { font-size: 1.1rem; font-weight: 700; color: var(--brand-navy); }
        .view-toggles button { background: white; border: 1px solid var(--brand-border); padding: 4px 10px; font-size: 0.75rem; cursor: pointer; border-radius: 4px; }
        .view-toggles button.active { background: var(--brand-navy); color: white; border-color: var(--brand-navy); }
        
        /* TABLE STYLES UPDATED FOR HIERARCHY */
        .q-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        .q-table th { text-align: left; padding: 10px; background: #F9FAFB; color: #6B7280; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; border-bottom: 1px solid var(--brand-border); }
        .q-table td { padding: 8px 10px; border-bottom: 1px solid var(--brand-border); vertical-align: middle; }
        
        /* New Hierarchy Styles */
        .room-section-header td { background: #1E3A8A; color: white; font-weight: 800; font-size: 0.9rem; padding: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .category-row td { background: #EFF6FF; color: #1E3A8A; font-weight: 700; font-size: 0.85rem; padding-top: 10px; border-top: 1px solid #DBEAFE; }
        .subcategory-row td { color: #6B7280; font-weight: 600; font-size: 0.8rem; padding-left: 25px; font-style: italic; background: #F9FAFB; }
        
        /* Tags for Ouvrage view */
        .breakdown-badge { display: inline-block; background: #F3F4F6; border: 1px solid #E5E7EB; border-radius: 4px; padding: 2px 6px; font-size: 0.7rem; margin-right: 4px; margin-top: 2px; color: #4B5563; }

        .qty-inp { width: 50px; text-align: center; padding: 4px; border: 1px solid #D1D5DB; border-radius: 4px; }
        .tva-select { padding: 4px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.8rem; background: white; cursor: pointer; }
        .note-input { width: 100%; border: 1px solid transparent; background: transparent; font-size: 0.8rem; color: #4B5563; font-style: italic; padding: 4px; border-radius: 4px; }
        .note-input:focus { background: white; border: 1px solid #D1D5DB; font-style: normal; outline: none; }
        
        /* VISIBILITY LOGIC FOR COLUMNS */
        body.mode-brouillon .col-price, 
        body.mode-brouillon .col-total, 
        body.mode-brouillon .col-tva { display: none; }
        
        /* MODIFIED: Show Cost in Devis Mode (as requested) but hide Time/Note */
        body.mode-devis .col-time, 
        body.mode-devis .col-note { display: none; } 

        .client-info-box { margin-bottom: 20px; }
        .client-label { font-size: 0.7rem; color: #9CA3AF; text-transform: uppercase; margin-top: 8px; display: block; }
        .client-input { width: 100%; border: none; background: transparent; font-weight: 500; padding: 2px 0; border-bottom: 1px dashed transparent; color: var(--brand-dark); }
        .client-input:hover { border-bottom-color: #D1D5DB; background: #F9FAFB; }
        .client-input[readonly] { color: #666; background: #f3f3f3; border-bottom-style: dotted; cursor: not-allowed; }
        .total-box { background: #F8FAFC; border: 1px solid var(--brand-border); padding: 15px; border-radius: var(--radius-sm); margin-top: 20px; }
        .fin-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.85rem; }
        .fin-input-row label { color: #4B5563; }
        .fin-input { width: 80px; text-align: right; padding: 3px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.85rem; }
        .t-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; color: #4B5563; }
        .t-row.main-total { border-top: 2px solid #D1D5DB; padding-top: 10px; margin-top: 10px; font-size: 1.2rem; font-weight: 800; color: var(--brand-navy); }
        .tva-breakdown { font-size: 0.75rem; color: #666; margin: 10px 0; border-top: 1px dashed #ddd; border-bottom: 1px dashed #ddd; padding: 5px 0; }
        .tva-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .client-list-item { padding: 15px; border-bottom: 1px solid var(--brand-border); cursor: pointer; transition: background 0.2s; }
        .client-list-item:hover { background: #F9FAFB; }
        .client-list-item.selected { background: #EFF6FF; border-left: 4px solid var(--brand-navy); }
        .cli-name { font-weight: 700; color: var(--brand-navy); font-size: 0.95rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 5px; }
        .form-group.full-width { grid-column: span 2; }
        .form-label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--brand-dark); margin-bottom: 4px; text-transform: uppercase; }
        .form-input { width: 100%; padding: 8px; border: 1px solid var(--brand-border); border-radius: 6px; font-size: 0.9rem; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        .history-table th { text-align: left; padding: 8px; background: #F3F4F6; }
        .history-table td { padding: 8px; border-bottom: 1px solid #E5E7EB; }
        
        /* --- MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 25000; display: none; align-items: center; justify-content: center; }
        .modal-large { background: white; padding: 0; border-radius: 12px; width: 90%; max-width: 800px; height: 90%; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--brand-border); display: flex; justify-content: space-between; align-items: center; background: #F9FAFB; }
        .modal-title-text { font-size: 1.25rem; font-weight: 800; color: var(--brand-navy); }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--brand-border); display: flex; justify-content: flex-end; gap: 10px; background: white; }
        .section-divider { margin: 25px 0 15px 0; border-bottom: 2px solid #F3F4F6; padding-bottom: 5px; color: var(--brand-navy); font-weight: 700; font-size: 1rem; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        .checkbox-group label { margin: 0; font-weight: 500; font-size: 0.9rem; cursor: pointer; }
        
        /* --- ROOM SELECTION GRID --- */
        .room-grid-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .room-select-btn { padding: 10px; border: 1px solid var(--brand-border); border-radius: 8px; background: white; cursor: pointer; font-size: 0.9rem; text-align: center; transition: all 0.2s; }
        .room-select-btn:hover { background: #EFF6FF; border-color: var(--brand-navy); color: var(--brand-navy); }
        .room-select-btn.active { background: var(--brand-navy); color: white; border-color: var(--brand-navy); }

        /* --- DEMOLITION STYLES --- */
        .demo-search-box { margin-bottom: 15px; position: relative; }
        .demo-search-input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 0.95rem; }
        .demo-search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF; }
        .demo-list { list-style: none; max-height: 400px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 8px; }
        .demo-item { padding: 15px; border-bottom: 1px solid #F3F4F6; cursor: pointer; transition: background 0.15s; display: flex; justify-content: space-between; align-items: center; }
        .demo-item:last-child { border-bottom: none; }
        .demo-item:hover { background-color: #F9FAFB; }
        .demo-item-content { flex: 1; }
        .demo-ref { font-size: 0.75rem; color: #6B7280; font-weight: 600; margin-bottom: 2px; }
        .demo-title { font-weight: 600; color: var(--brand-dark); font-size: 0.95rem; margin-bottom: 2px; }
        .demo-desc { font-size: 0.8rem; color: #6B7280; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .demo-price-tag { background: #ECFDF5; color: #047857; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 0.85rem; white-space: nowrap; margin-left: 15px; }
        
        #pdf-modal .modal-content { width: 400px; height: auto; } /* Specific for small pdf modal */

        .pdf-option { display: block; width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #E5E7EB; border-radius: 8px; background: #F9FAFB; cursor: pointer; text-align: left; transition: all 0.2s; }
        .pdf-option:hover { background: #EFF6FF; border-color: var(--brand-navy); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 20000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--brand-yellow); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-bar { display: flex; gap: 15px; padding: 15px; background: white; border-bottom: 1px solid var(--brand-border); align-items: flex-end; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.75rem; font-weight: 600; color: #6B7280; text-transform: uppercase; }
        .filter-input { padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 0.85rem; min-width: 150px; }
        
        /* --- PRINT / PDF FIXES --- */
        @media print {
            .q-table tr { page-break-inside: avoid; }
            .category-row, .subcategory-row { page-break-after: avoid; }
            .section-divider { page-break-before: always; }
        }
        .html2pdf__page-break { page-break-before: always; }

        @media (max-width: 900px) {
            .header-search-container { display: none; }
            .header-right-actions { display: none; }
            #quote-view aside:first-child { position: fixed; top: 64px; left: -280px; width: 280px; height: calc(100% - 64px); background: white; z-index: 100; transition: left 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            #quote-view aside:first-child.mobile-active { left: 0; }
            #quote-view { grid-template-columns: 1fr; gap: 15px; padding: 10px; grid-auto-rows: min-content 1fr min-content; }
            #quote-view aside:last-child { order: 3; max-height: none; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .filter-input { width: 100%; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .room-grid-selector { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>

<body class="mode-brouillon">

    <div id="login-screen">
        <div class="login-card">
            <div class="login-logo">Q</div>
            <h1 class="login-title">QOTIA Connect</h1>
            <form onsubmit="App.handleLogin(event)">
                <input type="text" id="login-user" class="login-input" placeholder="Identifiant (admin)" required>
                <input type="password" id="login-pass" class="login-input" placeholder="Mot de passe (admin)" required>
                <button type="submit" class="login-btn">Se Connecter</button>
            </form>
            <div style="margin-top:15px; font-size:0.8rem; color:#888;">Gestion BTP & Facturation</div>
        </div>
    </div>

    <div class="gs-overlay" id="gs-overlay" onclick="App.toggleGlobalMenu()"></div>
    <aside id="global-sidebar">
        <div class="gs-header">
            <div class="header-brand">
                <div class="logo-circle">Q</div>
                <div class="header-title">QOTIA</div>
            </div>
            <button class="global-menu-btn" onclick="App.toggleGlobalMenu()" aria-label="Close menu"><i class="fas fa-times"></i></button>
        </div>
        <nav class="gs-links">
            <div class="gs-link" onclick="App.navigate('home')"><i class="fas fa-home"></i> Accueil</div>
            <div class="gs-link" onclick="App.openProjectModal()"><i class="fas fa-plus-circle"></i> Nouveau Projet</div>
            <div class="gs-link" onclick="App.navigate('quote')"><i class="fas fa-edit"></i> Éditeur</div>
            <div class="gs-link" onclick="App.navigate('list')"><i class="fas fa-history"></i> Historique</div>
            <div class="gs-link" onclick="App.navigate('client')"><i class="fas fa-users"></i> Clients</div>
            <hr style="border-top:1px solid #eee; margin:5px 0;">
            <div class="gs-link" onclick="App.saveProject()"><i class="fas fa-save"></i> Sauvegarder Projet</div>
            <div class="gs-link" onclick="document.getElementById('load-file').click()"><i class="fas fa-folder-open"></i> Charger Projet</div>
            <hr style="border-top:1px solid #eee; margin:5px 0;">
            <div class="gs-link" onclick="App.navigate('company')"><i class="fas fa-building"></i> Mon Entreprise</div>
            <div class="gs-link" onclick="App.openPdfModal()"><i class="fas fa-print"></i> Stampa</div>
            <div class="gs-link" onclick="App.handleLogout()" style="color:var(--brand-danger); margin-top:auto;"><i class="fas fa-sign-out-alt"></i> Déconnexion</div>
        </nav>
    </aside>

    <input type="file" id="load-file" hidden accept=".json" onchange="App.loadProjectFile(event)">
    <input type="file" id="load-client-db" hidden accept=".json" onchange="App.loadClientDBFile(event)">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight:600; color:var(--brand-navy)">Chargement...</div>
    </div>

    <div class="app-container">
        <header class="top-header">
            <div class="header-left">
                <button class="global-menu-btn" onclick="App.toggleGlobalMenu()" aria-label="Open menu"><i class="fas fa-bars"></i></button>
                <div class="header-brand" onclick="App.showView('home')">
                    <div class="logo-circle">Q</div>
                    <div class="header-title">QOTIA</div>
                </div>
            </div>

            <div class="header-search-container">
                <div class="header-search-box">
                    <i class="fas fa-search header-search-icon"></i>
                    <input type="text" class="header-search-input" placeholder="Rechercher client, devis..." onkeyup="App.globalSearch(this.value)">
                </div>
            </div>

            <div class="header-right-actions">
                <button class="nav-link-btn" id="nav-list" onclick="App.showView('list')">
                    <i class="fas fa-history"></i> Historique
                </button>
                <button class="nav-link-btn" id="nav-clients" onclick="App.showView('client')">
                    <i class="fas fa-users"></i> Client
                </button>
                <button class="nav-link-btn btn-accent" onclick="App.openProjectModal()">
                    <i class="fas fa-plus-circle"></i> +Projet
                </button>
                <button class="nav-link-btn" onclick="App.openPdfModal()">
                    <i class="fas fa-print"></i> Imprimer
                </button>
            </div>
        </header>

        <main id="home-view" class="view-section active-section">
            <div class="dash-header">
                <div>
                    <h2 class="dash-title">Tableau de Bord</h2>
                    <div class="dash-subtitle">Bienvenue sur votre espace de gestion.</div>
                </div>
                <div class="kpi-filter-box">
                    <label style="font-size:0.8rem;color:#666">Période d'analyse :</label>
                    <select id="kpi-period" class="kpi-select" onchange="App.renderHome()">
                        <option value="all">Tout l'historique</option>
                        <option value="year" selected>Année en cours</option>
                        <option value="month">Mois en cours</option>
                        <option value="prev_year">Année précédente</option>
                    </select>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card clickable" onclick="App.navigateToHistory('')">
                    <div class="kpi-icon" style="background:#EFF6FF; color:#1E40AF;"><i class="fas fa-file-invoice"></i></div>
                    <div class="kpi-label">Total Devis</div>
                    <div class="kpi-value" id="kpi-total-count">0</div>
                    <div class="kpi-sub">Sur la période</div>
                </div>
                <div class="kpi-card clickable" onclick="App.navigateToHistory('attente')">
                    <div class="kpi-icon" style="background:#FFF7ED; color:#C2410C;"><i class="fas fa-clock"></i></div>
                    <div class="kpi-label">Brouillons / Attente</div>
                    <div class="kpi-value" id="kpi-pending-count">0</div>
                    <div class="kpi-sub" id="kpi-pending-amount">0.00 €</div>
                </div>
                <div class="kpi-card clickable" onclick="App.navigateToHistory('accepte')">
                    <div class="kpi-icon" style="background:#ECFDF5; color:#047857;"><i class="fas fa-check-circle"></i></div>
                    <div class="kpi-label">Devis Acceptés</div>
                    <div class="kpi-value" id="kpi-accepted-count">0</div>
                    <div class="kpi-sub" id="kpi-accepted-amount">0.00 €</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background:#F0F9FF; color:#0369A1;"><i class="fas fa-chart-line"></i></div>
                    <div class="kpi-label">CA Signé (Accepté)</div>
                    <div class="kpi-value" id="kpi-volume">0 €</div>
                    <div class="kpi-sub">Total facturable</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-box">
                    <div class="sidebar-title" style="border:none; padding:0 0 10px 0; font-size:0.9rem;">Répartition par Statut</div>
                    <div class="chart-container"><canvas id="statusChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="sidebar-title" style="border:none; padding:0 0 10px 0; font-size:0.9rem;">Évolution du Chiffre d'Affaires</div>
                    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                </div>
            </div>
        </main>

        <main id="list-view" class="view-section">
            <div class="card" style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                <div class="sidebar-title" style="font-size: 1.1rem; border-bottom: 1px solid #eee;">Historique Complet des Devis</div>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Rechercher</label>
                        <input type="text" id="dash-search" class="filter-input" placeholder="Client, Ref..." onkeyup="App.renderDashboardList()">
                    </div>
                    <div class="filter-group">
                        <label>Statut</label>
                        <select id="dash-status" class="filter-input" onchange="App.renderDashboardList()">
                            <option value="">Tous</option>
                            <option value="brouillon">Brouillon</option>
                            <option value="attente">En attente</option>
                            <option value="accepte">Accepté</option>
                            <option value="refuse">Refusé</option>
                        </select>
                    </div>
                    <div style="flex: 1;"></div>
                    <button class="btn btn-secondary" onclick="App.renderDashboardList()"><i class="fas fa-sync"></i></button>
                </div>
                <div class="col-scroll" style="padding: 0;">
                    <table class="dash-table">
                        <thead><tr><th>Date</th><th>Réf.</th><th>Client</th><th>Description / Projet</th><th style="text-align: right;">Montant TTC</th><th style="text-align: center;">Statut</th><th style="text-align: center;">Action</th></tr></thead>
                        <tbody id="dashboard-tbody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <main id="quote-view" class="view-section">
            <aside class="col-scroll" id="left-sidebar">
                <div class="card" style="min-height: 100%;">
                    <div class="sidebar-title">
                        <span id="lib-title-text">Bibliothèque</span>
                        <i class="fas fa-times mobile-menu-btn" onclick="App.toggleSidebar()" style="font-size:1rem;"></i>
                    </div>
                    <ul class="category-list" id="main-families-list"></ul>
                    <div id="subfamily-panel">
                        <div class="subfamily-header" id="back-to-families"><i class="fas fa-arrow-left"></i> Retour</div>
                        <div id="subcategories-container"></div>
                    </div>
                </div>
            </aside>

            <section class="workspace col-scroll">
                <div class="room-nav" id="room-list-container"></div>
                <div class="metrics-panel" id="metrics-panel">
                    <div class="m-group"><label>Long. (m)</label><input type="number" id="inp-L" step="0.01" oninput="App.calcMetrics()"></div>
                    <div class="m-group"><label>Larg. (m)</label><input type="number" id="inp-l" step="0.01" oninput="App.calcMetrics()"></div>
                    <div class="m-group"><label>H. (m)</label><input type="number" id="inp-h" step="0.01" value="2.70" oninput="App.calcMetrics()"></div>
                    <div style="width:1px;background:#FCD34D;height:30px;margin:0 5px;"></div>
                    <div class="m-group"><label>Surface (m²)</label><input type="text" id="out-surf" readonly></div>
                    <div class="m-group"><label>Périmètre (m)</label><input type="text" id="out-peri" readonly></div>
                    <div class="m-group"><label>Surf. Mur (m²)</label><input type="text" id="out-wall" readonly></div>
                </div>
                <div class="card" style="padding: 15px;">
                    <div class="quote-header">
                        <div class="quote-title" id="table-title">Détail Devis</div>
                        
                        <div class="mode-switch-internal" id="quote-mode-switch">
                            <button class="mode-btn active" id="btn-brouillon" onclick="App.setMode('brouillon')">Étude</button>
                            <button class="mode-btn" id="btn-devis" onclick="App.setMode('devis')">Devis</button>
                        </div>

                        <div class="view-toggles" style="margin-left:auto; margin-right:10px;">
                            <button class="active" id="view-piece" onclick="App.setView('piece')">Par Pièce</button>
                            <button id="view-ouvrage" onclick="App.setView('ouvrage')">Récap. Ouvrages</button>
                        </div>
                        <button class="btn btn-secondary" style="font-size:0.8rem; margin-right:5px;" onclick="App.calculateProfitability()">
                            <i class="fas fa-euro-sign" style="color:#059669; margin-right:5px;"></i> Analisi Margine
                        </button>
                        <button class="btn btn-secondary" style="font-size:0.8rem;" onclick="App.openDemolitionModal()">
                            <i class="fas fa-hammer" style="color:#B91C1C; margin-right:5px;"></i> Import Démolition
                        </button>
                    </div>
                    <table class="q-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Désignation</th><th style="width: 5%;">U</th><th style="width: 5%;">Qté</th><th class="col-tva" style="width: 10%;">TVA</th><th class="col-price" style="width: 10%;">P.U.</th>
                                <th class="col-cost" style="width: 10%;">Matériel</th>
                                <th class="col-total" style="width: 10%;">Total HT</th><th class="col-time" style="width: 8%;">Temps</th><th class="col-note" style="width: 15%;">Notes</th><th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="quote-tbody"></tbody>
                    </table>
                </div>
            </section>

            <aside class="col-scroll">
                <div class="card" style="padding: 15px;">
                    <div class="sidebar-title" style="padding:0 0 10px 0; border:none; background:transparent;">Client & Projet <button style="background:none;border:none;color:var(--brand-navy);cursor:pointer;" onclick="App.showView('client')"><i class="fas fa-user-edit"></i></button></div>
                    <div class="client-info-box">
                        <label class="client-label">Nom / Raison Sociale</label><input type="text" id="cli-name" class="client-input" placeholder="Nom Client" onchange="App.saveState()">
                        <label class="client-label">Nom du Projet</label><input type="text" id="cli-project-name" class="client-input" placeholder="Ex: Rénovation Cuisine" onchange="App.saveState()">
                        <label class="client-label">Adresse</label><input type="text" id="cli-addr" class="client-input" placeholder="Adresse" onchange="App.saveState()">
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <div style="flex:1"><label class="client-label">Date</label><input type="date" id="cli-date" class="client-input" onchange="App.saveState()"></div>
                            <div style="flex:1"><label class="client-label">N° Devis (Auto)</label><input type="text" id="cli-ref" class="client-input" readonly></div>
                        </div>
                    </div>
                    <div style="text-align:center; padding-bottom:10px; border-bottom:1px solid #eee;">
                        <button class="btn btn-primary" style="font-size:0.75rem; width:100%;" onclick="App.addCurrentQuoteToHistory()"><i class="fas fa-save"></i> Sauvegarder dans Historique</button>
                    </div>
                </div>
                <div class="card summary-sec" style="padding: 15px;">
                    <div class="sidebar-title" style="padding:0 0 10px 0; font-size:0.85rem; background:transparent;">Répartition par Poste</div>
                    <table style="width:100%; font-size:0.8rem;"><tbody id="category-summary-tbody"></tbody></table>
                </div>
                <div class="card total-box">
                    <div class="sidebar-title" style="padding:0 0 10px 0; font-size:0.85rem; border:none; background:transparent;">Total Devis</div>
                    <div style="margin-bottom: 10px; display:flex; align-items:center; gap:8px;">
                         <input type="checkbox" id="autoliquidation-chk" onchange="App.updateSummaries()" style="cursor:pointer">
                         <label for="autoliquidation-chk" style="font-size:0.8rem; color:var(--brand-navy); font-weight:600; cursor:pointer;">Autoliquidation (Sous-traitance)</label>
                    </div>
                    <div class="fin-input-row" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                        <label>Remise Globale (%)</label>
                        <input type="number" id="global-discount" class="fin-input" value="0" min="0" max="100" onchange="App.updateGlobalDiscount(this.value)">
                    </div>
                    <div id="financial-summary-body"></div>
                    <div class="fin-input-row" style="margin-top:10px; border-top:1px solid #eee; padding-top:5px;">
                        <label>Acompte Versé (€)</label>
                        <input type="number" id="deposit-amount" class="fin-input" value="0" min="0" onchange="App.updateDeposit(this.value)">
                    </div>
                    <div class="t-row" style="margin-top:5px; font-weight:700; color:#059669;"><span>Reste à Payer</span><span id="final-to-pay">0.00 €</span></div>
                </div>
            </aside>
        </main>

        <main id="client-view" class="view-section">
            <aside class="col-scroll">
                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="sidebar-title">Liste Clients <button class="btn-secondary" style="padding:4px 8px; font-size:0.7rem;" onclick="App.newClient()"><i class="fas fa-plus"></i></button></div>
                    <div style="padding:10px; border-bottom:1px solid #eee;"><input type="text" class="form-input" placeholder="Rechercher..." onkeyup="App.filterClients(this.value)"></div>
                    <div id="client-list" style="flex:1; overflow-y:auto;"></div>
                </div>
            </aside>
            <section class="col-scroll">
                <div class="card" style="padding: 25px;">
                    <div style="margin-bottom:20px;">
                        <h2 style="font-size:1.5rem; color:var(--brand-navy); font-weight:bold; margin-bottom:15px;">Fiche Client</h2>
                        
                        <div class="type-switch" style="display:flex; background:#f3f4f6; border-radius:8px; padding:4px;">
                            <button class="type-btn active" id="btn-physique" onclick="App.setClientType('physique')" style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.2s;">
                                <i class="fas fa-user"></i> Personne Physique
                            </button>
                            <button class="type-btn" id="btn-morale" onclick="App.setClientType('morale')" style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.2s; color:#6B7280;">
                                <i class="fas fa-building"></i> Personne Morale
                            </button>
                        </div>
                    </div>

                    <form id="client-form" class="form-grid">
                        <input type="hidden" id="c-id">

                        <div class="form-group full-width grp-morale" style="display:none;">
                            <label class="form-label">Raison Sociale (Entreprise)</label>
                            <input type="text" id="c-company" class="form-input" placeholder="Ex: Maçonnerie Durand">
                        </div>
                        <div class="form-group grp-morale" style="display:none;">
                            <label class="form-label">Forme Juridique</label>
                            <select id="c-legal-form" class="form-input">
                                <option value="SARL">SARL</option>
                                <option value="SAS">SAS</option>
                                <option value="SASU">SASU</option>
                                <option value="EURL">EURL</option>
                                <option value="SCI">SCI</option>
                                <option value="EI">EI / Auto-ent.</option>
                                <option value="SA">SA</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group grp-morale" style="display:none;">
                            <label class="form-label">Représentant Légal</label>
                            <input type="text" id="c-rep-name" class="form-input" placeholder="Nom du gérant/référent">
                        </div>
                        <div class="form-group grp-morale" style="display:none;">
                            <label class="form-label">SIRET</label>
                            <input type="text" id="c-siret" class="form-input">
                        </div>
                        <div class="form-group grp-morale" style="display:none;">
                            <label class="form-label">TVA Intracommunautaire</label>
                            <input type="text" id="c-tva" class="form-input">
                        </div>
                        <div class="form-group grp-morale" style="display:none;">
                            <label class="form-label">Email Facturation (si différent)</label>
                            <input type="email" id="c-billing-email" class="form-input">
                        </div>

                        <div class="form-group grp-physique">
                            <label class="form-label">Civilité</label>
                            <select id="c-civility" class="form-input">
                                <option value="M.">Monsieur (M.)</option>
                                <option value="Mme">Madame (Mme)</option>
                            </select>
                        </div>
                        <div class="form-group grp-physique"></div> 

                        <div class="form-group grp-physique">
                            <label class="form-label">Nom</label>
                            <input type="text" id="c-lastname" class="form-input">
                        </div>
                        <div class="form-group grp-physique">
                            <label class="form-label">Prénom</label>
                            <input type="text" id="c-firstname" class="form-input">
                        </div>

                        <div class="form-group full-width" style="margin-top:10px; border-top:1px dashed #e5e7eb; padding-top:10px;">
                            <label class="form-label">Coordonnées & Contact</label>
                        </div>

                        <div class="form-group full-width">
                            <label class="form-label">Adresse Complète</label>
                            <input type="text" id="c-addr" class="form-input" placeholder="Numéro, Rue, Code Postal, Ville">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Principal</label>
                            <input type="email" id="c-email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Téléphone Mobile</label>
                            <input type="tel" id="c-mobile" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Téléphone Fixe</label>
                            <input type="tel" id="c-phone" class="form-input">
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">Notes / Commentaires (Interne)</label>
                            <textarea id="c-note" class="form-input" rows="3" style="font-family:inherit; resize:vertical;"></textarea>
                        </div>
                    </form>

                    <div style="display:flex; gap:15px; margin-top:20px;">
                        <button class="btn btn-primary" type="button" onclick="App.saveClientToDB()">Enregistrer Fiche</button>
                        <button class="btn btn-secondary" type="button" style="background:#ECFDF5; border-color:#10B981; color:#065F46;" onclick="App.useClientInQuote()">Utiliser ce client</button>
                        <div style="flex:1"></div>
                        <button class="btn btn-secondary" type="button" style="color:var(--brand-danger);" onclick="App.deleteClientFromDB()">Supprimer</button>
                    </div>
                </div>
            </section>
        </main>
        <main id="company-view" class="view-section">
            <div class="col-scroll">
                <div class="card" style="padding: 30px;">
                    <h2 style="color:var(--brand-navy); font-weight:800; margin-bottom:10px;">Mon Entreprise</h2>
                    <p style="color:#666; margin-bottom:30px;">Ces informations apparaitront sur vos devis et factures.</p>
                    <div style="margin-bottom:20px; background:#EFF6FF; padding:15px; border-radius:8px; border:1px solid #DBEAFE;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" id="user-is-ei" style="cursor:pointer; width:18px; height:18px;">
                            <label for="user-is-ei" style="font-weight:700; color:var(--brand-navy); font-size:0.95rem; cursor:pointer;">Entrepreneur Individuel (EI)</label>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group full-width"><label class="form-label">Nom de l'entreprise</label><input type="text" id="user-company" class="form-input"></div>
                        <div class="form-group full-width"><label class="form-label">Adresse</label><input type="text" id="user-address" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Ville / CP</label><input type="text" id="user-city" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Téléphone</label><input type="text" id="user-phone" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Email</label><input type="text" id="user-email" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Site Web</label><input type="text" id="user-web" class="form-input"></div>
                        <div class="form-group"><label class="form-label">SIRET</label><input type="text" id="user-siret" class="form-input"></div>
                        <div class="form-group"><label class="form-label">TVA Intra.</label><input type="text" id="user-tva" class="form-input"></div>
                    </div>
                    <div class="card" style="margin-top:30px; border-color:#FCD34D;">
                        <div class="box-header" style="background:#FFFBEB; color:#92400E;"><i class="fas fa-shield-alt"></i> Assurance Décennale / RC Pro</div>
                        <div style="padding:20px;" class="form-grid">
                            <div class="form-group"><label class="form-label">Nom Assureur</label><input type="text" id="ins-name" class="form-input"></div>
                            <div class="form-group"><label class="form-label">N° Contrat / Police</label><input type="text" id="ins-policy" class="form-input"></div>
                            <div class="form-group full-width"><label class="form-label">Adresse Assureur</label><input type="text" id="ins-addr" class="form-input"></div>
                            <div class="form-group full-width"><label class="form-label">Couverture</label><input type="text" id="ins-geo" class="form-input" value="France Métropolitaine"></div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="box-header"><i class="fas fa-university"></i> Coordonnées Bancaires (RIB)</div>
                        <div style="padding:20px;" class="form-grid">
                            <div class="form-group full-width"><label class="form-label">Banque</label><input type="text" id="bank-name" class="form-input"></div>
                            <div class="form-group full-width"><label class="form-label">IBAN</label><input type="text" id="bank-iban" class="form-input"></div>
                            <div class="form-group"><label class="form-label">BIC</label><input type="text" id="bank-bic" class="form-input"></div>
                        </div>
                    </div>
                    <hr style="margin: 30px 0; border:0; border-top:1px dashed #ddd;">
                    <h3 style="color:var(--brand-navy); font-weight:700; margin-bottom:15px;">Administration</h3>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Utilisateur Admin</label><input type="text" id="admin-user" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Mot de passe</label><input type="text" id="admin-pass" class="form-input"></div>
                    </div>
                    <div style="margin-top:30px; text-align:right;">
                        <button class="btn btn-primary" onclick="App.saveUserCompanyData()">Enregistrer les modifications</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="project-modal">
        <div class="modal-large">
            <div class="modal-header">
                <span class="modal-title-text"><i class="fas fa-hammer"></i> Nouveau Projet</span>
                <button class="global-menu-btn" onclick="document.getElementById('project-modal').style.display='none'"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="project-wizard-body">
                <div class="section-divider">1. Client Principal</div>
                <div style="margin-bottom:15px;">
                    <label class="form-label">Sélectionner ou Créer</label>
                    <select id="proj-client-select" class="form-input" onchange="ProjectService.handleClientSelection(this.value)">
                        <option value="new">+ Créer un nouveau client</option>
                    </select>
                </div>
                
                <div id="proj-new-client-form" class="form-grid" style="background:#f9fafb; padding:15px; border-radius:8px; border:1px solid #eee;">
                    <div class="form-group full-width"><label class="form-label">Type</label>
                        <select id="proj-c-type" class="form-input" onchange="ProjectService.toggleCompanyFields(this.value)">
                            <option value="private">Particulier</option>
                            <option value="company">Société</option>
                        </select>
                    </div>
                    <div class="form-group full-width" id="proj-c-company-grp" style="display:none;"><label class="form-label">Raison Sociale</label><input type="text" id="proj-c-company" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Nom</label><input type="text" id="proj-c-lastname" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Prénom</label><input type="text" id="proj-c-firstname" class="form-input"></div>
                    <div class="form-group full-width"><label class="form-label">Email</label><input type="email" id="proj-c-email" class="form-input"></div>
                    <div class="form-group full-width"><label class="form-label">Adresse Facturation</label><input type="text" id="proj-c-addr" class="form-input"></div>
                </div>

                <div class="section-divider">2. Détails du Cantiere (Lieu des travaux)</div>
                <div class="form-grid">
                    <div class="form-group full-width"><label class="form-label">Nom du Projet (Ref. Interne)</label><input type="text" id="proj-name" class="form-input" placeholder="Ex: Rénovation Apt. Dupuis"></div>
                    
                    <div class="form-group full-width"><label class="form-label">Adresse du Chantier (Si différente)</label><input type="text" id="proj-address" class="form-input" placeholder="Rue, Ville, CP"></div>
                    
                    <div class="form-group"><label class="form-label">Immeuble / Résidence</label><input type="text" id="proj-building" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Digicode / Accès</label><input type="text" id="proj-code" class="form-input"></div>

                    <div class="form-group"><label class="form-label">Etage</label><input type="text" id="proj-floor" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Total Etages Immeuble</label><input type="text" id="proj-total-floors" class="form-input"></div>

                    <div class="form-group"><label class="form-label">Ascenseur</label>
                        <select id="proj-elevator" class="form-input"><option value="yes">Oui</option><option value="no">Non</option></select>
                    </div>
                    <div class="form-group"><label class="form-label">Sur rue principale ?</label>
                        <select id="proj-street-facing" class="form-input"><option value="no">Non</option><option value="yes">Oui</option></select>
                    </div>

                    <div class="form-group"><label class="form-label">Chauffage</label>
                        <select id="proj-heating" class="form-input"><option value="individual">Individuel</option><option value="collective">Collectif</option></select>
                    </div>
                    <div class="form-group"><label class="form-label">Gardien / Custode</label><input type="text" id="proj-guardian" class="form-input"></div>

                    <div class="form-group full-width"><label class="form-label">Syndic (Nom & Contact)</label><input type="text" id="proj-syndic" class="form-input"></div>
                    <div class="form-group full-width"><label class="form-label">Président Conseil Syndical</label><input type="text" id="proj-syndic-pres" class="form-input"></div>

                    <div class="form-group"><label class="form-label">Plombier Immeuble (Nom)</label><input type="text" id="proj-plumber-name" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Plombier Immeuble (Tel)</label><input type="text" id="proj-plumber-tel" class="form-input"></div>

                    <div class="form-group full-width"><label class="form-label">Emplacement Robinet Arrêt Général</label><input type="text" id="proj-shutoff-loc" class="form-input"></div>
                    <div class="form-group full-width"><label class="form-label">Emplacement Compteurs (Gaz/Elec)</label><input type="text" id="proj-meters-loc" class="form-input"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('project-modal').style.display='none'">Annuler</button>
                <button class="btn btn-primary" onclick="ProjectService.createFullProjectStack()">Créer Projet & Devis</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="room-selection-modal">
        <div class="modal-large" style="max-width: 600px; height: auto; max-height: 90%;">
            <div class="modal-header">
                <span class="modal-title-text">Ajouter une Pièce</span>
                <button class="global-menu-btn" onclick="document.getElementById('room-selection-modal').style.display='none'"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="room-grid-selector" id="room-grid"></div>
                <div style="margin-top: 20px;">
                    <label class="form-label">Précisions (ex: "Principale", "Côté Sud")</label>
                    <input type="text" id="room-precision-input" class="form-input" placeholder="Optionnel">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('room-selection-modal').style.display='none'">Annuler</button>
                <button class="btn btn-primary" onclick="App.confirmAddRoom()">Ajouter</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="demo-modal">
        <div class="modal-large" style="height:80%;">
            <div class="modal-header">
                <span class="modal-title-text"><i class="fas fa-hammer"></i> Bibliothèque Démolition</span>
                <button class="global-menu-btn" onclick="document.getElementById('demo-modal').style.display='none'"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div class="demo-search-box">
                    <i class="fas fa-search demo-search-icon"></i>
                    <input type="text" id="demo-search-input" class="demo-search-input" placeholder="Rechercher (ex: Mur, Carrelage, Fenêtre...)" onkeyup="App.filterDemolitionList()">
                </div>
                <ul class="demo-list" id="demo-list-container"></ul>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="pdf-modal">
        <div class="modal-content">
            <div class="modal-title" style="margin-bottom:15px; font-weight:bold; color:var(--brand-navy);"><i class="fas fa-print"></i> Centre d'exportation</div>
            <div style="text-align:left; font-size:0.75rem; color:#999; margin-bottom:5px; text-transform:uppercase;">Documents Courants</div>
            <button class="pdf-option" onclick="PDFService.generate('devis')"><i class="fas fa-file-invoice-dollar" style="width:20px; color:#F59E0B;"></i> Devis Simple</button>
            <button class="pdf-option" onclick="PDFService.generate('facture')"><i class="fas fa-file-invoice" style="width:20px; color:#10B981;"></i> Facture Simple</button>
            <div style="text-align:left; font-size:0.75rem; color:#999; margin-bottom:5px; margin-top:15px; text-transform:uppercase;">Rapports d'Activité</div>
            <button class="pdf-option" onclick="PDFService.generate('client_list')"><i class="fas fa-users" style="width:20px; color:#1E3A8A;"></i> Liste Clients</button>
            <button class="pdf-option" onclick="PDFService.generate('month_summary')"><i class="fas fa-calendar-alt" style="width:20px; color:#6366f1;"></i> Récapitulatif Mois</button>
            <button class="pdf-option" onclick="PDFService.generate('accepted_quotes')"><i class="fas fa-check-circle" style="width:20px; color:#059669;"></i> Devis Acceptés</button>
            <button class="btn btn-secondary" style="margin-top:15px; width:100%;" onclick="document.getElementById('pdf-modal').style.display='none'">Fermer</button>
        </div>
    </div>

    <script>

  /**
 * QOTIA PRO 2025 - CORE ENGINE v2.1
 */

const Config = {
    LIBRARY_URL: 'library.json',
    DEFAULT_ROOM_HEIGHT: 2.70,
    HOURLY_RATE: 50
};

// Variabili globali per la biblioteca
let CATEGORY_MAP = {};
let DEMOLITION_DB = [];

const PREDEFINED_ROOMS = [
    "Entrée", "Séjour", "Salon", "Salle à manger", "Véranda", 
    "Bibliothèque", "Salle TV", "Cuisine ouverte", "Cuisine séparée", 
    "Chambre principale", "Chambre secondaire", "Chambre d'enfant", "Chambre d'amis",
    "Suite parentale", "Dressing", "Salle de bain", "Salle d'eau", 
    "WC séparé", "Buanderie", "Couloir", "Dégagement", "Autre"
];

const Utils = {
    el: (id) => document.getElementById(id),
    val: (id) => document.getElementById(id)?.value || '',
    setVal: (id, val) => { const el = document.getElementById(id); if (el) el.value = val; },
    formatEuro: (num) => num.toFixed(2) + ' €',
    generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2)
};

const Store = {
    data: {
        rooms: ["Travaux préparatoires"],
        activeRoom: "Travaux préparatoires",
        roomData: {},
        quoteItems: [],
        clientsDB: [], 
        projectsDB: [], 
        currentClient: null,
        currentProject: null,
        globalDiscount: 0,
        depositAmount: 0,
        userCompany: {
            name: 'Mon Entreprise', address: '1 rue de la Paix', city: '75000 Paris',
            phone: '0100000000', email: 'contact@entreprise.com', web: 'www.entreprise.com',
            siret: '', tva: '', adminUser: 'admin', adminPass: 'admin',
            isEI: false, insurance: { name: '', policy: '', addr: '', geo: '' },
            bank: { name: '', iban: '', bic: '' }
        }
    },
    save() {
        localStorage.setItem('qotia_state', JSON.stringify(this.data));
    },
    load() {
        const saved = localStorage.getItem('qotia_state');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                this.data = { ...this.data, ...parsed };
                if (!Array.isArray(this.data.rooms)) this.data.rooms = ["Travaux préparatoires"];
            } catch (e) { console.error("Errore storage", e); }
        }
    }
};

const BusinessLogic = {
    calculateFinancials(items, globalDiscount, depositAmount, isAutoliquidation) {
        let totalHT = 0, totalTime = 0, breakdown = {};
        items.forEach(i => {
            let rowHT = i.qty * i.price;
            totalHT += rowHT;
            totalTime += i.qty * i.time;
            let effectiveTVA = isAutoliquidation ? 0 : i.tva;
            let k = effectiveTVA.toFixed(3);
            if (!breakdown[k]) breakdown[k] = 0;
            breakdown[k] += rowHT;
        });
        let discountMultiplier = 1 - (globalDiscount / 100);
        let discountedHT = totalHT * discountMultiplier;
        let totalTVA = 0, breakdownFinal = {};
        for (let rate in breakdown) {
            let base = breakdown[rate] * discountMultiplier;
            let tvaAmt = base * parseFloat(rate);
            totalTVA += tvaAmt;
            breakdownFinal[rate] = { base: base, tva: tvaAmt };
        }
        return { totalHT, totalTime, discountedHT, totalTVA, totalTTC: discountedHT + totalTVA, toPay: (discountedHT + totalTVA) - depositAmount, breakdownFinal, isAutoliquidation };
    },
    getFlatQuotes(clients) {
        let allQuotes = [];
        clients.forEach(c => {
            const cName = c.type === 'company' ? c.company : `${c.lastname} ${c.firstname}`;
            if (c.quotes) c.quotes.forEach((q, qIndex) => allQuotes.push({ clientId: c.id, qIndex, clientName: cName, ...q }));
        });
        return allQuotes.sort((a, b) => new Date(b.date) - new Date(a.date));
    },
    generateNextRef(clients) {
        const year = new Date().getFullYear();
        let max = 0;
        clients.forEach(c => c.quotes?.forEach(q => {
            const p = q.ref.split('-');
            if (p[1] == year && parseInt(p[2]) > max) max = parseInt(p[2]);
        }));
        return `D-${year}-${String(max + 1).padStart(3, '0')}`;
    }
};

const ProjectService = {
    initModal() {
        const sel = Utils.el('proj-client-select');
        sel.innerHTML = '<option value="new">+ Créer un nouveau client</option>';
        Store.data.clientsDB.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.text = c.type === 'company' ? c.company : `${c.lastname} ${c.firstname}`;
            sel.appendChild(opt);
        });
        Utils.el('proj-new-client-form').style.display = 'grid';
    },
    handleClientSelection(val) { Utils.el('proj-new-client-form').style.display = (val === 'new' ? 'grid' : 'none'); },
    toggleCompanyFields(type) { Utils.el('proj-c-company-grp').style.display = (type === 'company' ? 'block' : 'none'); },
    createFullProjectStack() {
        const clientVal = Utils.val('proj-client-select');
        let clientObj;
        if(clientVal === 'new') {
            clientObj = { id: Date.now(), type: Utils.val('proj-c-type'), lastname: Utils.val('proj-c-lastname'), firstname: Utils.val('proj-c-firstname'), company: Utils.val('proj-c-company'), email: Utils.val('proj-c-email'), addr: Utils.val('proj-c-addr'), quotes: [] };
            Store.data.clientsDB.push(clientObj);
        } else {
            clientObj = Store.data.clientsDB.find(c => c.id == clientVal);
        }
        const projId = Utils.generateId();
        const quoteRef = BusinessLogic.generateNextRef(Store.data.clientsDB);
        const quoteObj = { ref: quoteRef, date: new Date().toISOString().split('T')[0], amount: 0, status: 'brouillon', desc: Utils.val('proj-name'), projectId: projId, data: { rooms: ["Travaux préparatoires"], roomData: {}, quoteItems: [], globalDiscount: 0, depositAmount: 0 } };
        clientObj.quotes.push(quoteObj);
        Store.save();
        App.loadQuoteFromHistory(clientObj.id, clientObj.quotes.length - 1);
        Utils.el('project-modal').style.display = 'none';
        App.showView('quote');
    }
};

const App = {
    currentMode: 'brouillon',
    currentView: 'piece',
    chartInstances: {},

    async init() {
        this.checkLogin();
        Store.load();
        await this.loadExternalLibrary();
        this.renderCategories();
        this.renderAll();
        this.renderClientList();
        this.renderHome();
        this.renderDashboardList();
    },

    async loadExternalLibrary() {
        try {
            const res = await fetch(Config.LIBRARY_URL);
            const data = await res.json();
            CATEGORY_MAP = data.categories;
            DEMOLITION_DB = data.demolition_db;
        } catch (e) {
            console.warn("Usando database locale di emergenza");
            CATEGORY_MAP = { 'Installation': { icon: 'fa-hard-hat', subs: ['Protection'] } };
        }
    },

    checkLogin() { Utils.el('login-screen').style.display = sessionStorage.getItem('qotia_session') ? 'none' : 'flex'; },
    handleLogin(e) {
        e.preventDefault();
        if (Utils.val('login-user') === Store.data.userCompany.adminUser && Utils.val('login-pass') === Store.data.userCompany.adminPass) {
            sessionStorage.setItem('qotia_session', 'true');
            Utils.el('login-screen').style.display = 'none';
        } else alert("Erreur credentials");
    },
    handleLogout() { sessionStorage.removeItem('qotia_session'); location.reload(); },

    // --- NAVIGATION ---
    toggleGlobalMenu() { Utils.el('global-sidebar').classList.toggle('open'); Utils.el('gs-overlay').classList.toggle('active'); },
    toggleSidebar() { Utils.el('left-sidebar').classList.toggle('mobile-active'); },
    navigate(view) { this.showView(view); this.toggleGlobalMenu(); },
    showView(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-section'));
        Utils.el(view + '-view').classList.add('active-section');
        if(view === 'home') this.renderHome();
        if(view === 'list') this.renderDashboardList();
    },

    // --- LOGICA PIÈCES ---
    addNewRoom() {
        const grid = Utils.el('room-grid');
        grid.innerHTML = '';
        PREDEFINED_ROOMS.forEach(r => {
            const btn = document.createElement('div');
            btn.className = 'room-select-btn';
            btn.innerText = r;
            btn.onclick = () => {
                document.querySelectorAll('.room-select-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.selectedRoomType = r;
            };
            grid.appendChild(btn);
        });
        Utils.el('room-selection-modal').style.display = 'flex';
    },
    confirmAddRoom() {
        if(!this.selectedRoomType) return;
        const prec = Utils.val('room-precision-input');
        const name = this.selectedRoomType + (prec ? ` (${prec})` : '');
        if(!Store.data.rooms.includes(name)) {
            Store.data.rooms.push(name);
            Store.data.roomData[name] = { L: 0, l: 0, h: 2.7 };
            Store.data.activeRoom = name;
            Store.save();
            this.renderAll();
        }
        Utils.el('room-selection-modal').style.display = 'none';
    },
    switchRoom(r) { Store.data.activeRoom = r; this.renderAll(); },
    deleteRoom(e, r) {
        e.stopPropagation();
        if(r === "Travaux préparatoires" || !confirm("Supprimer?")) return;
        Store.data.rooms = Store.data.rooms.filter(x => x !== r);
        Store.data.quoteItems = Store.data.quoteItems.filter(i => i.piece !== r);
        Store.data.activeRoom = Store.data.rooms[0];
        Store.save(); this.renderAll();
    },

    // --- CALCOLI METRICI ---
    calcMetrics() {
        const r = Store.data.activeRoom;
        if (r === "Travaux préparatoires") return;
        const L = parseFloat(Utils.val('inp-L')) || 0, l = parseFloat(Utils.val('inp-l')) || 0, h = parseFloat(Utils.val('inp-h')) || 0;
        Store.data.roomData[r] = { L, l, h };
        Utils.setVal('out-surf', (L*l).toFixed(2));
        Utils.setVal('out-peri', ((L+l)*2).toFixed(2));
        Utils.setVal('out-wall', (((L+l)*2)*h).toFixed(2));
        Store.save();
        this.renderRooms();
    },

    // --- GESTIONE ARTICOLI ---
    renderCategories() {
        const list = Utils.el('main-families-list');
        list.innerHTML = '';
        Object.entries(CATEGORY_MAP).forEach(([cat, data]) => {
            let li = document.createElement('li');
            li.className = 'category-item';
            li.innerHTML = `<span><i class="fas ${data.icon}"></i> ${cat}</span> <i class="fas fa-chevron-right"></i>`;
            li.onclick = () => this.showSubCategories(cat);
            list.appendChild(li);
        });
    },
    showSubCategories(cat) {
        Utils.el('main-families-list').style.display = 'none';
        Utils.el('subfamily-panel').style.display = 'block';
        Utils.el('lib-title-text').innerText = cat;
        const cont = Utils.el('subcategories-container');
        cont.innerHTML = '';
        CATEGORY_MAP[cat].subs.forEach(sub => {
            let div = document.createElement('div');
            div.className = 'article-item';
            div.innerHTML = `<span>${sub}</span> <i class="fas fa-plus"></i>`;
            div.onclick = () => this.addItem(cat, sub, `Ouvrage ${sub}`);
            cont.appendChild(div);
        });
    },
    addItem(fam, sub, desc, unit='m²', price=30, time=0.5, mat=0) {
        Store.data.quoteItems.push({ id: Date.now(), piece: Store.data.activeRoom, fam, sub, desc, unit, qty: 1, price, time, matCost: mat, matIsTotal: false, tva: 0.1, note: "" });
        Store.save(); this.renderAll();
    },
    updateItem(id, field, val) {
        const item = Store.data.quoteItems.find(i => i.id === id);
        if (item) { item[field] = (field === 'note' ? val : parseFloat(val)); Store.save(); this.renderAll(); }
    },
    deleteItem(id) { Store.data.quoteItems = Store.data.quoteItems.filter(i => i.id !== id); Store.save(); this.renderAll(); },

    // --- RENDERING TABELLA ---
    renderTable() {
        const tbody = Utils.el('quote-tbody');
        tbody.innerHTML = '';
        const mode = this.currentMode;
        
        Store.data.rooms.forEach(room => {
            const items = Store.data.quoteItems.filter(i => i.piece === room);
            tbody.innerHTML += `<tr class="room-section-header"><td colspan="10">${room}</td></tr>`;
            
            let fams = [...new Set(items.map(i => i.fam))];
            fams.forEach(f => {
                tbody.innerHTML += `<tr class="category-row"><td colspan="10">${f}</td></tr>`;
                items.filter(i => i.fam === f).forEach(item => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${item.desc}</td><td>${item.unit}</td>
                        <td><input type="number" class="qty-inp" value="${item.qty}" onchange="App.updateItem(${item.id},'qty',this.value)"></td>
                        <td class="col-tva"><input type="number" class="qty-inp" step="0.001" value="${item.tva}" onchange="App.updateItem(${item.id},'tva',this.value)"></td>
                        <td class="col-price">${item.price}€</td>
                        <td class="col-cost"><input type="number" class="qty-inp" value="${item.matCost}" onchange="App.updateItem(${item.id},'matCost',this.value)"></td>
                        <td class="col-total"><strong>${(item.qty*item.price).toFixed(2)}€</strong></td>
                        <td class="col-time">${item.time}h</td>
                        <td class="col-note"><input type="text" class="note-input" value="${item.note}" onchange="App.updateItem(${item.id},'note',this.value)"></td>
                        <td><button onclick="App.deleteItem(${item.id})">X</button></td>
                    </tr>`;
                });
            });
        });
    },

    // --- ALTRE LOGICHE ---
    renderRooms() {
        const cont = Utils.el('room-list-container');
        cont.innerHTML = '';
        Store.data.rooms.forEach(r => {
            const btn = document.createElement('div');
            btn.className = `room-pill ${r === Store.data.activeRoom ? 'active' : ''}`;
            btn.innerHTML = `<span>${r}</span> <div class="delete-room-btn" onclick="App.deleteRoom(event,'${r}')">x</div>`;
            btn.onclick = () => this.switchRoom(r);
            cont.appendChild(btn);
        });
        const add = document.createElement('div');
        add.className = 'room-pill'; add.innerHTML = '+'; add.onclick = () => this.addNewRoom();
        cont.appendChild(add);
    },
    updateSummaries() {
        const fin = BusinessLogic.calculateFinancials(Store.data.quoteItems, Store.data.globalDiscount, Store.data.depositAmount, false);
        Utils.el('financial-summary-body').innerHTML = `Total HT: ${fin.totalHT.toFixed(2)}€ <br> Total TTC: ${fin.totalTTC.toFixed(2)}€`;
        Utils.el('final-to-pay').innerText = fin.toPay.toFixed(2) + " €";
    },
    saveState() { Store.save(); },
    renderClientList() { /* ... logica lista clienti ... */ },
    renderHome() { /* ... logica KPI dashboard ... */ },
    renderDashboardList() { /* ... logica tabella storico ... */ },
    loadQuoteFromHistory(cId, qIdx) {
        const c = Store.data.clientsDB.find(x => x.id == cId);
        const q = c.quotes[qIdx];
        Store.data.rooms = q.data.rooms;
        Store.data.roomData = q.data.roomData;
        Store.data.quoteItems = q.data.quoteItems;
        Store.data.activeRoom = Store.data.rooms[0];
        this.renderAll();
    }
};

window.App = App;
window.ProjectService = ProjectService;
window.PDFService = PDFService;
document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
