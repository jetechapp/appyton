<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QOTIA PRO 2025 | Gestion & Devis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS ORIGINALE INTEGRALE --- */
        :root { --brand-yellow: #FCD34D; --brand-yellow-dark: #F59E0B; --brand-navy: #1E3A8A; --brand-dark: #1F2937; --brand-grey-bg: #F3F4F6; --brand-white: #FFFFFF; --brand-border: #E5E7EB; --brand-danger: #EF4444; --brand-success: #10B981; --radius-md: 12px; --radius-sm: 8px; --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --header-height: 64px; --sidebar-width: 280px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; outline: none; }
        body { background-color: var(--brand-grey-bg); color: var(--brand-dark); line-height: 1.5; font-size: 13px; height: 100vh; overflow: hidden; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--brand-navy); z-index: 50000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-card { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--brand-border); border-radius: 8px; }
        .login-btn { width: 100%; padding: 12px; background: var(--brand-navy); color: white; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; }
        .app-container { display: flex; flex-direction: column; height: 100%; padding-top: var(--header-height); }
        .top-header { position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); background: white; border-bottom: 1px solid var(--brand-border); padding: 0 24px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; }
        #global-sidebar { position: fixed; top: 0; left: -300px; width: 260px; height: 100%; background: white; z-index: 2000; border-right: 1px solid var(--brand-border); transition: left 0.3s; }
        #global-sidebar.open { left: 0; }
        .gs-link { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; color: #4B5563; }
        .gs-link:hover { background: #F3F4F6; }
        .view-section { display: none; height: calc(100vh - 64px); overflow: hidden; }
        .view-section.active-section { display: grid; }
        .col-scroll { overflow-y: auto; height: 100%; padding: 20px; }
        .room-pill { background: white; border: 1px solid var(--brand-border); padding: 6px 12px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 600; }
        .room-pill.active { background: var(--brand-yellow); border-color: var(--brand-yellow-dark); }
        .q-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        .q-table th { background: #F9FAFB; padding: 12px; text-align: left; font-size: 11px; text-transform: uppercase; color: #6B7280; border-bottom: 1px solid #eee; }
        .q-table td { padding: 10px; border-bottom: 1px solid #F3F4F6; }
        .room-section-header td { background: var(--brand-navy); color: white; font-weight: 800; padding: 10px; }
        .category-row td { background: #EFF6FF; color: var(--brand-navy); font-weight: 700; }
        .metrics-panel { background: #FFFBEB; padding: 15px; border-radius: 12px; display: flex; gap: 15px; margin-bottom: 15px; border: 1px solid #FDE68A; }
        .metrics-panel input { width: 70px; padding: 5px; border-radius: 4px; border: 1px solid #ddd; text-align: right; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 400px; }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-card">
            <div style="font-size: 30px; font-weight: 800; color: var(--brand-navy); margin-bottom: 20px;">QOTIA</div>
            <form onsubmit="App.handleLogin(event)">
                <input type="text" id="login-user" class="login-input" placeholder="Admin ID" required>
                <input type="password" id="login-pass" class="login-input" placeholder="Password" required>
                <button type="submit" class="login-btn">Connexion</button>
            </form>
            <p style="margin-top: 15px; color: #888; font-size: 11px;">Identifiants par défaut: admin / admin</p>
        </div>
    </div>

    <aside id="global-sidebar">
        <div style="padding: 20px; font-weight: 800; color: var(--brand-navy); border-bottom: 1px solid #eee;">MENU</div>
        <div class="gs-link" onclick="App.navigate('home')"><i class="fas fa-home"></i> Dashboard</div>
        <div class="gs-link" onclick="App.openProjectModal()"><i class="fas fa-plus"></i> Nouveau Projet</div>
        <div class="gs-link" onclick="App.navigate('quote')"><i class="fas fa-edit"></i> Editeur Devis</div>
        <div class="gs-link" onclick="App.navigate('client')"><i class="fas fa-users"></i> CRM Clients</div>
        <div class="gs-link" onclick="App.handleLogout()" style="color: var(--brand-danger);"><i class="fas fa-sign-out-alt"></i> Déconnexion</div>
    </aside>

    <div class="app-container">
        <header class="top-header">
            <button onclick="App.toggleMenu()" style="background: none; border: none; font-size: 20px; cursor: pointer;"><i class="fas fa-bars"></i></button>
            <div style="font-weight: 800; color: var(--brand-navy); font-size: 18px;">QOTIA</div>
            <div style="display: flex; gap: 10px;">
                <button class="room-pill active" onclick="App.showView('quote')">Editeur</button>
                <button class="room-pill" onclick="App.openProjectModal()">+ Projet</button>
            </div>
        </header>

        <main id="home-view" class="view-section active-section">
            <div class="col-scroll">
                <h2>Tableau de Bord</h2>
                <div class="kpi-grid" style="margin-top: 20px;">
                    <div class="kpi-card"><span>Devis Totaux</span><h2 id="kpi-count">0</h2></div>
                    <div class="kpi-card"><span>Chiffre d'Affaires</span><h2 id="kpi-ca">0 €</h2></div>
                </div>
            </div>
        </main>

        <main id="quote-view" class="view-section" style="grid-template-columns: 260px 1fr 300px; gap: 0;">
            <aside class="col-scroll" style="background: white; border-right: 1px solid #eee;">
                <div style="font-weight: 700; margin-bottom: 15px;">Bibliothèque</div>
                <ul id="main-families-list" style="list-style: none;"></ul>
                <div id="subfamily-panel" style="display: none;">
                    <button onclick="App.hideSubs()" style="border: none; background: #eee; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">← Retour</button>
                    <div id="subcategories-container"></div>
                </div>
            </aside>

            <section class="col-scroll">
                <div id="room-nav-container" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;"></div>
                
                <div id="metrics-panel" class="metrics-panel">
                    <div><label>Long.</label><input type="number" id="inp-L" oninput="App.calcMetrics()"></div>
                    <div><label>Larg.</label><input type="number" id="inp-l" oninput="App.calcMetrics()"></div>
                    <div><label>H.</label><input type="number" id="inp-h" value="2.70" oninput="App.calcMetrics()"></div>
                    <div style="margin-left: auto; font-weight: 700;">Surface: <span id="out-surf">0.00</span> m²</div>
                </div>

                <table class="q-table">
                    <thead>
                        <tr><th>Désignation</th><th>Qté</th><th>P.U.</th><th>Total</th><th></th></tr>
                    </thead>
                    <tbody id="quote-tbody"></tbody>
                </table>
            </section>

            <aside class="col-scroll" style="background: white; border-left: 1px solid #eee;">
                <h3 style="margin-bottom: 20px;">Récapitulatif</h3>
                <div id="financial-summary" style="font-size: 16px; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    Total HT: 0.00 €
                </div>
                <button class="login-btn" onclick="PDFService.generate()">Générer PDF</button>
                <button class="login-btn" style="background: #10B981; margin-top: 10px;" onclick="App.saveToHistory()">Sauvegarder</button>
            </aside>
        </main>

        <main id="client-view" class="view-section" style="grid-template-columns: 300px 1fr;">
            <div class="col-scroll" style="background: white; border-right: 1px solid #eee;">
                <button class="login-btn" onclick="App.newClient()">+ Nouveau Client</button>
                <div id="client-list-cont" style="margin-top: 20px;"></div>
            </div>
            <div class="col-scroll">
                <h2>Fiche Client</h2>
                <form id="client-form" style="margin-top: 20px;">
                    <input type="hidden" id="c-id">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><label>Nom</label><input type="text" id="c-name" class="login-input"></div>
                        <div><label>Email</label><input type="email" id="c-email" class="login-input"></div>
                    </div>
                    <button type="button" class="login-btn" onclick="App.saveClient()">Enregistrer</button>
                </form>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="project-modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">Nouveau Projet</h3>
            <label>Nom du Chantier</label>
            <input type="text" id="proj-name" class="login-input" placeholder="Ex: Rénovation Appartement">
            <label>Client</label>
            <select id="proj-client-select" class="login-input"></select>
            <button class="login-btn" onclick="ProjectService.create()">Démarrer</button>
            <button onclick="Utils.el('project-modal').style.display='none'" style="margin-top: 10px; border: none; background: none; cursor: pointer; color: #666;">Annuler</button>
        </div>
    </div>

    <script>
        /* --- CORE JAVASCRIPT ENGINE --- */
        let CATEGORY_MAP = {}; 

        const Utils = {
            el: (id) => document.getElementById(id),
            val: (id) => document.getElementById(id)?.value || '',
            setVal: (id, v) => { if(Utils.el(id)) Utils.el(id).value = v; },
            txt: (id, t) => { if(Utils.el(id)) Utils.el(id).innerText = t; }
        };

        const Store = {
            data: {
                rooms: ["Travaux préparatoires"],
                activeRoom: "Travaux préparatoires",
                roomData: {},
                quoteItems: [],
                clientsDB: [],
                user: { adminUser: 'admin', adminPass: 'admin' }
            },
            save() { localStorage.setItem('qotia_v3_state', JSON.stringify(this.data)); },
            load() {
                const s = localStorage.getItem('qotia_v3_state');
                if(s) this.data = JSON.parse(s);
            }
        };

        const App = {
            async init() {
                Store.load();
                this.checkLogin();
                await this.loadLibrary();
                this.renderAll();
            },

            async loadLibrary() {
                try {
                    const res = await fetch('library.json');
                    const data = await res.json();
                    CATEGORY_MAP = data.categories;
                } catch(e) {
                    console.warn("Biblioteca esterna non trovata, carico default.");
                    CATEGORY_MAP = { "Général": { icon: "fa-info-circle", subs: ["Main d'oeuvre"] } };
                }
                this.renderLibrary();
            },

            checkLogin() {
                if(sessionStorage.getItem('qotia_auth')) Utils.el('login-screen').style.display = 'none';
            },

            handleLogin(e) {
                e.preventDefault();
                if(Utils.val('login-user') === Store.data.user.adminUser && Utils.val('login-pass') === Store.data.user.adminPass) {
                    sessionStorage.setItem('qotia_auth', 'true');
                    Utils.el('login-screen').style.display = 'none';
                } else alert("Erreur credentials");
            },

            handleLogout() { sessionStorage.removeItem('qotia_auth'); location.reload(); },

            toggleMenu() { Utils.el('global-sidebar').classList.toggle('open'); },
            navigate(v) { this.showView(v); this.toggleMenu(); },

            showView(v) {
                document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-section'));
                Utils.el(v + '-view').classList.add('active-section');
                if(v === 'client') this.renderClients();
                if(v === 'home') this.renderHome();
            },

            // --- STANZE ---
            renderRooms() {
                const cont = Utils.el('room-nav-container');
                cont.innerHTML = '';
                Store.data.rooms.forEach(r => {
                    const div = document.createElement('div');
                    div.className = `room-pill ${r === Store.data.activeRoom ? 'active' : ''}`;
                    div.innerHTML = `${r} <i class="fas fa-times" style="font-size:9px" onclick="App.deleteRoom(event, '${r}')"></i>`;
                    div.onclick = () => { Store.data.activeRoom = r; this.renderAll(); };
                    cont.appendChild(div);
                });
                const add = document.createElement('div');
                add.className = 'room-pill'; add.innerHTML = '<i class="fas fa-plus"></i>';
                add.onclick = () => {
                    const n = prompt("Nom de la pièce:");
                    if(n) { Store.data.rooms.push(n); Store.data.activeRoom = n; Store.save(); this.renderAll(); }
                };
                cont.appendChild(add);
            },

            deleteRoom(e, r) {
                e.stopPropagation();
                if(r === "Travaux préparatoires") return;
                Store.data.rooms = Store.data.rooms.filter(x => x !== r);
                Store.data.quoteItems = Store.data.quoteItems.filter(i => i.piece !== r);
                Store.data.activeRoom = Store.data.rooms[0];
                Store.save(); this.renderAll();
            },

            calcMetrics() {
                const r = Store.data.activeRoom;
                const L = parseFloat(Utils.val('inp-L')) || 0, l = parseFloat(Utils.val('inp-l')) || 0;
                Utils.txt('out-surf', (L*l).toFixed(2));
                Store.data.roomData[r] = { L, l, h: Utils.val('inp-h') };
                Store.save();
            },

            // --- BIBLIOTECA ---
            renderLibrary() {
                const list = Utils.el('main-families-list');
                list.innerHTML = '';
                Object.entries(CATEGORY_MAP).forEach(([name, data]) => {
                    const li = document.createElement('li');
                    li.style = "padding:10px; cursor:pointer; border-bottom:1px solid #f9f9f9;";
                    li.innerHTML = `<i class="fas ${data.icon}"></i> ${name}`;
                    li.onclick = () => {
                        Utils.el('main-families-list').style.display = 'none';
                        Utils.el('subfamily-panel').style.display = 'block';
                        const subC = Utils.el('subcategories-container');
                        subC.innerHTML = '';
                        data.subs.forEach(s => {
                            const d = document.createElement('div');
                            d.style = "padding:8px; border-bottom:1px dashed #eee; cursor:pointer;";
                            d.innerText = s;
                            d.onclick = () => this.addItem(name, s);
                            subC.appendChild(d);
                        });
                    };
                    list.appendChild(li);
                });
            },
            hideSubs() { Utils.el('main-families-list').style.display = 'block'; Utils.el('subfamily-panel').style.display = 'none'; },

            addItem(f, s) {
                Store.data.quoteItems.push({ id: Date.now(), piece: Store.data.activeRoom, fam: f, desc: s, unit: 'm²', qty: 1, price: 50 });
                Store.save(); this.renderAll();
            },

            updateItem(id, f, v) {
                const i = Store.data.quoteItems.find(x => x.id === id);
                if(i) { i[f] = (f === 'qty' || f === 'price' ? parseFloat(v) : v); Store.save(); this.renderAll(); }
            },

            deleteItem(id) { Store.data.quoteItems = Store.data.quoteItems.filter(x => x.id !== id); Store.save(); this.renderAll(); },

            // --- CRM ---
            renderClients() {
                const cont = Utils.el('client-list-cont');
                cont.innerHTML = '';
                Store.data.clientsDB.forEach(c => {
                    const d = document.createElement('div');
                    d.style = "padding:10px; border-bottom:1px solid #eee; cursor:pointer;";
                    d.innerHTML = `<i class="fas fa-user"></i> ${c.name}`;
                    d.onclick = () => { Utils.setVal('c-id', c.id); Utils.setVal('c-name', c.name); Utils.setVal('c-email', c.email); };
                    cont.appendChild(d);
                });
            },
            saveClient() {
                const c = { id: Utils.val('c-id') || Date.now(), name: Utils.val('c-name'), email: Utils.val('c-email'), quotes: [] };
                if(!c.name) return alert("Nom requis");
                Store.data.clientsDB.push(c); Store.save(); this.renderClients(); Utils.el('client-form').reset();
            },
            newClient() { Utils.el('client-form').reset(); Utils.setVal('c-id', ''); },

            // --- RENDERING ---
            renderAll() {
                this.renderRooms();
                this.renderTable();
                this.renderTotal();
            },
            renderTable() {
                const tbody = Utils.el('quote-tbody');
                tbody.innerHTML = '';
                const items = Store.data.quoteItems.filter(x => x.piece === Store.data.activeRoom);
                items.forEach(i => {
                    tbody.innerHTML += `<tr>
                        <td>${i.desc}</td>
                        <td><input type="number" value="${i.qty}" style="width:50px" onchange="App.updateItem(${i.id}, 'qty', this.value)"></td>
                        <td><input type="number" value="${i.price}" style="width:60px" onchange="App.updateItem(${i.id}, 'price', this.value)"></td>
                        <td>${(i.qty*i.price).toFixed(2)}€</td>
                        <td><button onclick="App.deleteItem(${i.id})" style="border:none; color:red; cursor:pointer;">X</button></td>
                    </tr>`;
                });
            },
            renderTotal() {
                const t = Store.data.quoteItems.reduce((acc, i) => acc + (i.qty*i.price), 0);
                Utils.txt('financial-summary', `Total HT: ${t.toFixed(2)} €`);
            },
            renderHome() {
                Utils.txt('kpi-count', Store.data.quoteItems.length);
                const t = Store.data.quoteItems.reduce((acc, i) => acc + (i.qty*i.price), 0);
                Utils.txt('kpi-ca', t.toFixed(2) + " €");
            },
            openProjectModal() {
                const sel = Utils.el('proj-client-select');
                sel.innerHTML = Store.data.clientsDB.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                Utils.el('project-modal').style.display = 'flex';
            },
            saveToHistory() { alert("Devis sauvegardé dans l'historique !"); }
        };

        const ProjectService = {
            create() {
                alert("Projet Initialisé");
                Utils.el('project-modal').style.display = 'none';
                App.showView('quote');
            }
        };

        const PDFService = {
            generate() { window.print(); }
        };

        window.App = App; window.ProjectService = ProjectService; window.PDFService = PDFService;
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
